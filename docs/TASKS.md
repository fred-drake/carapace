# Carapace Development Tasks

> Master task list generated by the AI planning team (2026-02-18).
> Updated after full team review (2026-02-18) — 6-role review incorporated.
> Updated (2026-02-19) — Wave 1 P1 tasks marked DONE (PRs #23-28). Auth design tasks
> added (ENG-23, DX-14, DEVOPS-19, DEVOPS-20) based on team analysis of nanoclaw
> reference implementation.
> Updated (2026-02-19) — Waves 2-5 P1 tasks marked DONE (PRs #29-55).
> Updated (2026-02-19) — Waves 6-9 P2 tasks marked DONE (PRs #56-67).
> Updated (2026-02-19) — Waves 10-14 P2 tasks marked DONE (PRs #68-91).
> Updated (2026-02-19) — Phase E2E tasks added and completed (ENG-24 through
> ENG-28, QA-11, PRs #103-108). End-to-end plumbing validated.
> Updated (2026-02-19) — Phase IMG image versioning tasks added and completed
> (IMG-01 through IMG-08, PRs #120-128).
> Organized by priority tier, then by role. Tasks reference each other by ID.

## Legend

- **P0** = Must build first (foundational, blocks everything)
- **P1** = Build next (core functionality, blocks features)
- **P2** = Build after core works (features, polish, hardening)
- **Complexity**: S (hours), M (1-2 days), L (3-5 days), XL (1+ week)

---

## P0 — Foundation

These tasks must be completed first. They establish the project skeleton, messaging
backbone, core routing, test infrastructure, and CI pipeline that everything else
depends on.

### ~~ARCH-01: Bootstrap project structure~~ DONE

**Status**: Completed (PR #1, merged 2026-02-18)
**Role**: Architect / Engineer
**Description**: Initialize package.json, tsconfig.json (strict mode), pnpm workspace
config, and directory layout: `src/core/`, `src/ipc/`, `src/plugins/`, `src/types/`,
`src/container/`. Configure path aliases and module resolution.
**Dependencies**: None
**Acceptance criteria**: `pnpm install && pnpm run build` succeeds with zero source
files. TypeScript strict mode enabled. ESM module system configured.
**Complexity**: S

### ~~ARCH-02: Define message envelope types~~ DONE

**Status**: Completed (PR #5, merged 2026-02-18)
**Role**: Architect / Engineer
**Description**: Create TypeScript interfaces for the full message protocol:
`WireMessage` (topic, correlation, arguments), `Envelope` (id, version, type, topic,
source, correlation, timestamp, group, payload), `EventPayload`, `RequestPayload`,
`ResponsePayload`. Define the `Topic` string literal union type from the topic
hierarchy. Define all 10 error code enums (`UNKNOWN_TOOL`, `VALIDATION_FAILED`,
`UNAUTHORIZED`, `RATE_LIMITED`, `CONFIRMATION_TIMEOUT`, `CONFIRMATION_DENIED`,
`PLUGIN_TIMEOUT`, `PLUGIN_UNAVAILABLE`, `PLUGIN_ERROR`, `HANDLER_ERROR`).
**Dependencies**: ARCH-01
**Acceptance criteria**: All message types compile. Wire format and envelope types have
zero overlap (enforced by type system). Topic hierarchy covers all documented topics.
All 10 error codes are defined with `retriable`, `stage`, `field`, and `retry_after`
metadata where applicable.
**Complexity**: M

### ~~ARCH-03: Define plugin manifest schema and types~~ DONE

**Status**: Completed (PR #6, merged 2026-02-18)
**Role**: Architect / Engineer
**Description**: Create TypeScript interfaces and JSON Schema for plugin manifests:
tool declarations (name, description, risk_level, argument schema), hook subscriptions,
and configuration schema. The manifest schema itself must enforce
`additionalProperties: false`.
**Dependencies**: ARCH-01
**Acceptance criteria**: A sample manifest validates correctly. Invalid manifests are
rejected with clear errors. TypeScript types match the JSON Schema.
**Complexity**: M

### ~~ENG-01: Implement ZeroMQ PUB/SUB event bus~~ DONE

**Status**: Completed (PR #13, merged 2026-02-18)
**Role**: Engineer
**Description**: Build the event bus using ZeroMQ PUB/SUB pattern over Unix domain
sockets. Core runs a PUB socket; plugins and container subscribe by topic prefix.
Support topic-based filtering. Handle socket lifecycle (bind, connect, close,
reconnect).
**Dependencies**: ARCH-01, ARCH-02
**Test requirements**: QA-01, QA-03. Test: topic filtering, multi-subscriber delivery,
unsubscribed topic exclusion, socket cleanup, reconnection after failure.
**Acceptance criteria**: Events published on a topic are received by all subscribers
to that topic. Unsubscribed topics are not received. Socket cleanup on shutdown is
clean (no lingering files).
**Complexity**: M

### ~~ENG-02: Implement ZeroMQ ROUTER/DEALER request channel~~ DONE

**Status**: Completed (PR #14, merged 2026-02-18)
**Role**: Engineer
**Description**: Build the request-response channel using ZeroMQ ROUTER/DEALER pattern.
Core runs ROUTER; agent and plugins connect as DEALERs. Core routes requests by topic
prefix to the correct plugin DEALER. Correlation IDs link requests to responses.
**Dependencies**: ARCH-01, ARCH-02
**Test requirements**: QA-01, QA-03. Test: correlation matching, concurrent requests,
unknown topic errors, timeouts, connection identity tracking.
**Acceptance criteria**: A DEALER sends a request and receives the correct response
matched by correlation ID. Requests to unknown topics return error responses. Multiple
concurrent requests are handled correctly.
**Complexity**: L

### ~~ENG-03: Implement core message router~~ DONE

**Status**: Completed (PR #18, merged 2026-02-18)
**Role**: Engineer
**Description**: Build the central router that receives messages from both channels,
constructs full envelopes from wire messages (adding id, version, type, source, group,
timestamp from session state), validates messages, and dispatches to the correct
handler or plugin. Implement the 6-stage validation pipeline incrementally via TDD:
Stage 1 (envelope construction) first, then Stages 2–6. This is the heart of the
system.
**Dependencies**: ENG-01, ENG-02, ARCH-02
**Test requirements**: QA-01, QA-02, QA-03. Test each pipeline stage individually:
envelope construction from wire+session, topic validation, payload validation, auth
check, rate limit, dispatch. Test malformed input does not crash.
**Acceptance criteria**: Wire messages from container are enriched into full envelopes.
Messages are routed to correct plugins by topic. Invalid messages are rejected with
appropriate error codes. Router does not crash on malformed input. Each of the 6
pipeline stages is independently testable.
**Complexity**: L

### ~~ENG-04: Implement plugin loader~~ DONE

**Status**: Completed (PR #19, merged 2026-02-18)
**Role**: Engineer
**Description**: Build the filesystem-based plugin discovery and loading system. Scan
`plugins/` directory at startup, parse and validate each manifest.json, instantiate
plugin handlers, register their tools in the router's dispatch table, and manage plugin
lifecycle (init, ready, shutdown). Handle initialization failures gracefully — failed
plugins are excluded from tool catalog and reported via `get_session_info`.
**Dependencies**: ARCH-03, ENG-03
**Test requirements**: QA-01, QA-02. Test: discovery (mock FS), manifest parse/reject,
handler lifecycle (init/ready/shutdown order), tool name collision detection, init
failure degradation, 10-point initialization failure behavior.
**Acceptance criteria**: Plugins in `plugins/` are auto-discovered and loaded. Invalid
manifests produce clear error messages and don't crash the system. Plugin tools are
routable after loading. Plugin lifecycle hooks fire in correct order. Failed plugins
are excluded from catalog, not from the system.
**Complexity**: L

### ~~QA-01: Set up test framework~~ DONE

**Status**: Completed (PR #7, merged 2026-02-18)
**Role**: QA
**Description**: Configure Vitest with TypeScript support, path alias resolution
matching tsconfig, and coverage reporting (v8 provider). Set up test directory
structure mirroring `src/`. Configure CI-friendly output format. Add test scripts
to package.json: `test`, `test:coverage`, `test:integration` (tagged), `test:security`
(tagged), `test:e2e` (tagged, Docker-required).
**Dependencies**: ARCH-01
**Acceptance criteria**: `pnpm test` runs unit tests. `pnpm test -- <path>` runs a
single file. `pnpm test:coverage` generates reports. `pnpm test:integration` runs
integration-tagged tests only. Vitest config handles TypeScript and path aliases.
**Complexity**: S

### ~~QA-02: Build test fixtures and factories~~ DONE

**Status**: Completed (PR #15, merged 2026-02-18)
**Role**: QA
**Description**: Create factory functions for common test objects: `createWireMessage()`,
`createEnvelope()`, `createManifest()`, `createPluginConfig()`, `createTestDatabase()`
(in-memory SQLite via better-sqlite3 `:memory:`), `createMemoryEntryFixture()`. These
produce valid defaults that can be overridden per-test. Avoids brittle tests coupled
to exact object shapes.
**Dependencies**: QA-01, ARCH-02, ARCH-03
**Acceptance criteria**: Factories produce valid objects that pass schema validation.
Any field can be overridden. Factories are typed — TypeScript catches invalid overrides
at compile time. SQLite test helpers create in-memory DBs with migrations applied.
**Complexity**: S

### ~~QA-03: Build ZeroMQ mock infrastructure~~ DONE

**Status**: Completed (PR #11, merged 2026-02-18)
**Role**: QA
**Description**: Create mock/fake ZeroMQ sockets for unit testing: `FakePubSocket`,
`FakeSubSocket`, `FakeRouterSocket`, `FakeDealerSocket`. These capture sent messages
and can be programmed to deliver responses. Avoid real socket I/O in unit tests.
Simulate failure modes: connection refused, socket timeout, message too large.
**Dependencies**: QA-01
**Acceptance criteria**: Unit tests using fake sockets run without real ZeroMQ. Fakes
capture all sent messages for assertion. Fakes can simulate responses, errors, and
timeouts. Fakes simulate failure modes (refused, timeout, oversized). API mirrors real
zeromq.js closely enough that tests are meaningful.
**Complexity**: M

### ~~QA-09: Build mock container runtime~~ DONE

**Status**: Completed (PR #12, merged 2026-02-18)
**Role**: QA
**Description**: Create a mock container runtime for testing session manager (ENG-06),
container lifecycle manager (DEVOPS-03), and container-related code without Docker.
The mock simulates: container spawn (returns mock connection identity), ZeroMQ
connection establishment, graceful and forced shutdown, resource cleanup verification.
Enables unit testing of container-adjacent code in CI without Docker.
**Dependencies**: QA-01
**Acceptance criteria**: Unit tests for session manager and lifecycle manager run
without Docker. Mock can simulate spawn failures, timeout, and crash scenarios.
Cleanup verification confirms no leaked resources.
**Complexity**: M

### ~~QA-10: Build IPC binary test harness~~ DONE

**Status**: Completed (PR #17, merged 2026-02-18)
**Role**: QA
**Description**: Create a test harness specifically for the `ipc` binary (ENG-05). The
binary is the container's sole communication channel — it must be thoroughly tested.
Harness tests: argument parsing, wire message construction, correlation ID generation,
timeout behavior, exit code semantics, stdout/stderr output formatting. Uses fake
ZeroMQ sockets from QA-03.
**Dependencies**: QA-01, QA-03
**Acceptance criteria**: IPC binary can be tested in isolation with fake sockets. All
error paths have tests. Exit codes are verified. Wire message construction is validated
against ARCH-02 types.
**Complexity**: S

### ~~DEVOPS-01: Create container Dockerfile~~ DONE

**Status**: Completed (PR #8, merged 2026-02-18)
**Role**: DevOps
**Description**: Build a multi-stage Dockerfile for the agent container. Build stage
compiles the `ipc` binary from TypeScript. Runtime stage uses Node.js 22 base with
read-only root filesystem. Copy only the compiled `ipc` binary and skill markdown
files. No package managers, no network tools, no credentials. Writable mounts for
workspace, `.claude/`, and ZeroMQ socket path. Define image tagging strategy
(git SHA + semantic version).
**Dependencies**: ARCH-01
**Acceptance criteria**: Container builds successfully via multi-stage build. Root
filesystem is read-only. No network access from inside container. Only `ipc` binary
is executable. Writable mounts work for workspace and socket. Image tags follow
versioning strategy.
**Complexity**: M

### ~~DEVOPS-02: Configure CI pipeline~~ DONE

**Status**: Completed (PR #9, merged 2026-02-18)
**Role**: DevOps
**Description**: Set up GitHub Actions CI with a multi-stage pipeline designed for
fast feedback first, security scanning second, integration tests last. See the
CI Pipeline Design section below for full stage breakdown and quality gates.
**Dependencies**: ARCH-01, QA-01
**Acceptance criteria**: CI runs on push/PR with all quality gates. Stages run in
correct order with parallelization within stages. Merge is blocked on: lint errors,
type errors, unit test failures, coverage below thresholds, Semgrep high/critical
findings, CodeQL high/critical findings. Cache node_modules and Nix store. Pipeline
completes in under 10 minutes for PR checks.
**Complexity**: L

---

## P1 — Core Functionality

These tasks build on the foundation to deliver a working system that can run an agent
session end-to-end, with full validation, error handling, and testing.

### ~~ENG-05: Build IPC binary (container-side CLI)~~ DONE

**Status**: Completed (PR #33, merged 2026-02-19)
**Role**: Engineer
**Description**: Implement the `ipc` CLI tool that runs inside the container. It
accepts tool invocation arguments from Claude Code (via Bash), constructs a wire
message (topic, correlation, arguments), sends it to the host via ZeroMQ DEALER
socket, waits for the response, and prints the result to stdout. This is the
container's only way to communicate with the host.
**Dependencies**: ENG-02, ARCH-02
**Note**: Does NOT depend on ENG-03 or ENG-04. Can be built in parallel with the
core router, shortening the critical path.
**Test requirements**: QA-10 (IPC test harness), QA-03 (fake sockets). Test: CLI arg
parsing, wire message construction, correlation generation, timeout, exit codes,
stdout/stderr formatting.
**Acceptance criteria**: `ipc tool.invoke.create_reminder '{"title":"test"}'` sends a
valid wire message and prints the response. Correlation IDs are generated per
invocation. Timeout on no response. Exit codes reflect success/failure.
**Complexity**: M

### ~~ENG-06: Implement session manager~~ DONE

**Status**: Completed (PR #23, merged 2026-02-19)
**Role**: Engineer
**Description**: Build the session manager that tracks active agent sessions: which
container is running, which group it belongs to, session start time, and the ZeroMQ
connection identity for that session. The router uses this to construct envelope
identity fields from trusted state.
**Dependencies**: ENG-03
**Test requirements**: QA-01, QA-02, QA-09 (mock container runtime). Test: session
CRUD, connection→session mapping, concurrent session isolation, cleanup on teardown.
**Acceptance criteria**: Sessions are created when containers spawn and destroyed on
teardown. Router can look up group/source from connection identity. Concurrent sessions
for different groups are isolated.
**Complexity**: M

### ~~ENG-07: Implement schema validation engine~~ DONE

**Status**: Completed (PR #24, merged 2026-02-19)
**Role**: Engineer
**Description**: Build a validation layer that validates tool arguments against their
declared JSON Schemas (from plugin manifests). Enforce `additionalProperties: false`
on all schemas. Produce clear validation error messages with the JSON path to the
invalid field. Uses ajv.
**Dependencies**: ARCH-03
**Test requirements**: QA-01. Test: valid/invalid schemas, additionalProperties
rejection, nested field validation, error path formatting with JSON pointer, prototype
pollution keys (`__proto__`, `constructor`) handling.
**Acceptance criteria**: Valid arguments pass validation. Extra properties are rejected.
Missing required fields are caught. Error messages include the JSON path to the problem.
Prototype pollution keys are safely handled.
**Complexity**: M

### ~~ENG-08: Implement SQLite data layer~~ DONE

**Status**: Completed (PR #27, merged 2026-02-19)
**Role**: Engineer
**Description**: Build the SQLite connection manager and migration system. Support
per-feature, per-group databases at `data/{feature}/{group}.sqlite`. Migrations are
TypeScript files run in order. Connection pooling is not needed (better-sqlite3 is
synchronous). Validate group names against `[a-zA-Z0-9_-]` to prevent path traversal.
**Dependencies**: ARCH-01
**Test requirements**: QA-01, QA-02 (SQLite test helpers). Test: connection
create/reuse, migration ordering, idempotent migrations, per-feature/per-group path
resolution, group name validation rejects traversal patterns. Use in-memory SQLite.
**Acceptance criteria**: Databases are created on first access at the correct path.
Migrations run in order and are idempotent. Schema changes are versioned. Connection
handles are reused within a session. Group names with `../` or invalid characters
are rejected.
**Complexity**: M

### ~~ENG-09: Build skill file loader~~ DONE

**Status**: Completed (PR #35, merged 2026-02-19)
**Role**: Engineer
**Description**: Implement the system that reads container-side skill markdown files
from `plugins/{name}/skills/` and prepares them for injection into the container's
`.claude/` directory. Also auto-generate skill files for core intrinsic tools. Skills
teach Claude what tools are available.
**Dependencies**: ENG-04
**Test requirements**: QA-01. Test: discovery from plugin dirs, content reading,
missing file warnings (not crashes), auto-generation for intrinsic tools.
**Acceptance criteria**: Skill files are discovered from plugin directories. Skills are
collected and prepared for container mount. Missing skill files produce warnings, not
crashes. Intrinsic tool skills are auto-generated.
**Complexity**: S

### ~~ENG-14: Implement core intrinsic tools~~ DONE

**Status**: Completed (PR #39, merged 2026-02-19)
**Role**: Engineer
**Description**: Implement the three core intrinsic tools documented in ARCHITECTURE.md:
`get_diagnostics` (query session-scoped audit log by correlation ID or recent errors),
`list_tools` (enumerate available tools with descriptions and risk levels),
`get_session_info` (return current group, session start time, plugin health with
healthy/failed categories). These are compiled into the core, registered in the same
tool catalog as plugin tools, and go through the full 6-stage validation pipeline.
**Dependencies**: ENG-03, ENG-06, ENG-17
**Test requirements**: QA-01, QA-02. Test: all three tools invokable via standard
pipeline, `list_tools` returns intrinsic + plugin tools, `get_session_info` shows
plugin health categories, `get_diagnostics` filters by correlation ID.
**Acceptance criteria**: All three tools are invokable via `ipc tool.invoke.{name}`.
`list_tools` returns all registered plugin and intrinsic tools. `get_session_info`
includes plugin health status (healthy + failed with error category). `get_diagnostics`
queries audit log entries. Tools pass full validation pipeline.
**Complexity**: M

### ~~ENG-15: Implement user confirmation gate (Stage 5)~~ DONE

**Status**: Completed (PR #47, merged 2026-02-19)
**Role**: Engineer
**Description**: Build the user confirmation mechanism for `risk_level: "high"` tools.
When a tool invocation reaches Stage 5 of the validation pipeline, the core pauses
execution and surfaces the request for user approval (through the channel that
initiated the session, or a default approval channel). Handle confirmation timeout
(configurable, default 5 minutes → `CONFIRMATION_TIMEOUT`) and explicit denial
(`CONFIRMATION_DENIED`). Clean up pending confirmation state on timeout/denial.
**Dependencies**: ENG-03, SEC-01
**Test requirements**: QA-01, QA-02. Test: high-risk tools pause, approval proceeds,
denial returns CONFIRMATION_DENIED, timeout returns CONFIRMATION_TIMEOUT, low-risk
tools bypass entirely, pending state cleanup.
**Acceptance criteria**: High-risk tool invocations pause for user confirmation.
Approved requests proceed to Stage 6. Denied requests return `CONFIRMATION_DENIED`.
Timed-out requests return `CONFIRMATION_TIMEOUT`. Low-risk tools bypass this stage.
**Complexity**: L

### ~~ENG-16: Implement core services interface~~ DONE

**Status**: Completed (PR #45, merged 2026-02-19)
**Role**: Engineer
**Description**: Build the `CoreServices` interface that plugin handlers receive during
`initialize()`: `getAuditLog(filters)`, `getToolCatalog()`, `getSessionInfo()`.
Implement automatic group-scoping using `AsyncLocalStorage` (or equivalent) so handlers
never pass group/session IDs — the core manages request context internally.
`getAuditLog` accepts `correlation`, `topic`, `outcome`, `last_n`, and time ranges
but never `group` or `sessionId` as filter keys.
**Dependencies**: ENG-03, ENG-06, ENG-17
**Test requirements**: QA-01, QA-02. Test: services are group-scoped automatically,
getAuditLog never returns cross-group entries, TypeScript autocomplete works.
**Acceptance criteria**: Handlers receive a `services` object at init. Core services
are automatically scoped to the group of the current request. `getAuditLog` never
returns entries from other groups. TypeScript provides full autocomplete.
**Complexity**: M

### ~~ENG-17: Implement audit log subsystem~~ DONE

**Status**: Completed (PR #25, merged 2026-02-19)
**Role**: Engineer
**Description**: Build the host-side audit log system. Structured JSON Lines format,
one object per line. Each entry includes: timestamp, group, source, topic, correlation,
stage, and outcome (`routed`, `rejected`, `sanitized`, `error`). Validation rejections
include the stage that failed and reason. Response sanitization events log field paths
affected (not redacted values). Handler errors log two entries per error (before and
after normalization), linked by correlation ID. Storage at `data/audit/`.
**Dependencies**: ENG-03
**Test requirements**: QA-01. Test: every message type is logged, rejection entries
include stage and reason, sanitization events logged, dual-entry handler error logging,
structured JSON Lines format, queryable by correlation ID.
**Acceptance criteria**: Every message crossing the trust boundary is logged. Rejection
entries include stage and reason. Sanitization events are logged. Dual-entry handler
error logging works. Logs are structured JSON Lines. Logs are queryable by correlation
ID for `get_diagnostics`.
**Complexity**: M

### ~~ENG-18: Implement ToolError class and error response handling~~ DONE

**Status**: Completed (PR #32, merged 2026-02-19)
**Role**: Engineer
**Description**: Implement the `ToolError` class exported from `@carapace/sdk`. Build
the core's error discrimination logic: return values → success response, `ToolError`
throws → structured error response, other throws → generic `PLUGIN_ERROR` (no
internals leaked), handler timeout → `PLUGIN_TIMEOUT`. Implement all 10 documented
error codes. Enforce response payload size limits (default 1MB). Ensure error responses
pass through the full Response Path (Sanitize → Log → Forward).
**Dependencies**: ARCH-02, ENG-03
**Test requirements**: QA-01, QA-02. Test: all 10 error codes produce correct envelopes,
instanceof ToolError discrimination works, non-ToolError throws produce generic
PLUGIN_ERROR, error responses are sanitized, oversized responses produce HANDLER_ERROR.
Test instanceof edge cases: plain object with ToolError fields, different module
instance, `__proto__` manipulation.
**Acceptance criteria**: All 10 error codes are implemented. `instanceof ToolError`
discrimination works. Non-ToolError throws produce generic `PLUGIN_ERROR`. Error
responses are sanitized. Oversized responses produce `HANDLER_ERROR`. Error codes
include correct metadata (`retriable`, `stage`, `field`, `retry_after`).
**Complexity**: M

### ~~ENG-19: Implement event-to-agent decision logic~~ DONE

**Status**: Completed (PR #56, merged 2026-02-19)
**Role**: Engineer
**Description**: Build the core's logic for deciding when PUB/SUB events warrant
spawning a new agent container. `message.inbound` events spawn an agent if the group
matches a configured group. `task.triggered` events always spawn an agent with the
task prompt. Other event types are logged but do not spawn agents. Handle the case
where a session is already active for a group (queue, reject, or run concurrent —
configurable).
**Dependencies**: ENG-01, ENG-06, DEVOPS-03
**Test requirements**: QA-01, QA-02, QA-09 (mock container runtime). Test: inbound
events for configured groups spawn containers, unmatched groups are dropped,
task.triggered always spawns, concurrent session policy is enforced.
**Acceptance criteria**: `message.inbound` events for configured groups spawn agent
containers. `task.triggered` events spawn agents with the task prompt. Unmatched groups
are logged and dropped. Concurrent session policy is configurable.
**Complexity**: M

### ~~SEC-01: Implement host-side message validation~~ DONE

**Status**: Completed (PR #38, merged 2026-02-19)
**Role**: Security
**Description**: Build the validation pipeline that every message from the container
passes through: schema validation (JSON Schema), topic whitelist check (only declared
tools), group authorization (session group matches target), and rate limiting. This is
the real security layer — the secondary boundary after container isolation.
**Dependencies**: ENG-03, ENG-06, ENG-07, SEC-03
**Test requirements**: QA-01, QA-02, QA-04 (integration harness). Test each stage
independently: schema validation rejects bad args, topic whitelist rejects unknown
tools, group auth blocks cross-group, rate limiter throttles floods. All rejections
produce correct error codes and are logged.
**Acceptance criteria**: Messages with invalid schemas are rejected. Messages to
undeclared topics are rejected. Cross-group access attempts are blocked. Rate-limited
sessions receive throttle errors. All rejections are logged with stage and reason.
**Complexity**: L

### ~~SEC-02: Implement response sanitization~~ DONE

**Status**: Completed (PR #36, merged 2026-02-19)
**Role**: Security
**Description**: Build a sanitization pass that scrubs plugin responses before they're
forwarded to the container. Strip common credential patterns: Bearer tokens, API keys
(X-API-Key, sk-\*, etc.), OAuth tokens, connection strings. Implement as part of the
3-stage Response Path: Sanitize → Log → Forward. Defense-in-depth against plugin
authors accidentally leaking secrets.
**Dependencies**: ENG-03, ENG-17
**Test requirements**: QA-01. Test: Bearer tokens sanitized, API key patterns caught,
sanitization doesn't corrupt valid data, sanitization events logged with field paths.
**Acceptance criteria**: Responses containing Bearer tokens are sanitized. Common API
key patterns are caught. Sanitization doesn't corrupt valid response data. Sanitization
events are logged for audit. Full Response Path (Sanitize → Log → Forward) works.
**Complexity**: M

### ~~SEC-03: Implement rate limiter~~ DONE

**Status**: Completed (PR #30, merged 2026-02-19)
**Role**: Security
**Description**: Build a per-session and per-group rate limiter for tool invocations.
Configurable limits (requests per minute, burst size). Token bucket or sliding window
algorithm. Rate limit state lives in memory (not SQLite — ephemeral by design).
**Dependencies**: ENG-06
**Test requirements**: QA-01. Test: sessions exceeding limit get throttle error, limits
configurable per group, burst handling works, state resets on session teardown,
accuracy under concurrent load (±5% at boundary).
**Acceptance criteria**: Sessions exceeding the rate limit receive throttle error
responses with `retry_after`. Limits are configurable per group. Burst handling works
correctly. Rate limit state resets on session teardown.
**Complexity**: M

### ~~SEC-07: Implement container security verification~~ DONE

**Status**: Completed (PR #59, merged 2026-02-19)
**Role**: Security / DevOps
**Description**: Verify that the built container enforces all security constraints
claimed in the architecture. Distinct from DEVOPS-01 (which builds it) — this task
_validates_ it. Tests verify: (1) root filesystem is read-only, (2) no network access
(attempt DNS, HTTP, raw socket), (3) only `ipc` binary is executable, (4)
settings.json is read-only, (5) skill files and CLAUDE.md are read-only, (6) writable
mounts limited to workspace, `.claude/` session dirs, and ZeroMQ socket, (7) no
package managers or shells beyond required.
**Dependencies**: DEVOPS-01, DEVOPS-03, DEVOPS-10
**Test requirements**: Automated test suite that spins up a container and attempts each
prohibited action. Runs in CI alongside QA-06 (Docker-required).
**Acceptance criteria**: Each prohibited action is tested and proven to fail. Tests run
in CI. Any regression in container security is immediately caught.
**Complexity**: M

### ~~SEC-08: Implement message size limits and DoS prevention~~ DONE

**Status**: Completed (PR #26, merged 2026-02-19)
**Role**: Security / Engineer
**Description**: Implement and test message size limits at the trust boundary: (1)
maximum wire message size (reject before JSON parsing to prevent memory exhaustion),
(2) maximum request payload size (1MB default, configurable), (3) maximum response
payload size (1MB), (4) maximum argument string length per field, (5) maximum JSON
depth to prevent stack overflow in parser.
**Dependencies**: ENG-03
**Test requirements**: QA-01. Test: oversized messages rejected before full parsing,
deeply nested JSON rejected, all limits configurable, boundary conditions covered.
**Acceptance criteria**: Messages exceeding size limits are rejected before full
parsing. Deeply nested JSON (100+ levels) is rejected. All limits are configurable.
Tests cover boundary conditions.
**Complexity**: M

### ~~SEC-10: Implement plugin manifest security validation~~ DONE

**Status**: Completed (PR #37, merged 2026-02-19)
**Role**: Security
**Description**: Security-harden the manifest loading process beyond ARCH-03's schema
validation: (1) validate all `arguments_schema` objects contain
`additionalProperties: false`, (2) limit schema complexity (max depth, max properties,
no recursive `$ref` for validator DoS), (3) validate skill file paths don't contain
path traversal (`../`), (4) validate tool names against allowed characters (prevent
injection through topic strings), (5) enforce maximum manifest file size.
**Dependencies**: ARCH-03, ENG-04
**Test requirements**: QA-01. Test each attack vector: missing additionalProperties,
recursive $ref, path traversal in skill paths, special chars in tool names.
**Acceptance criteria**: Manifests missing `additionalProperties: false` on any tool
schema are rejected at startup with clear error. Path traversal is blocked. Recursive
schemas are detected. Tests cover each vector.
**Complexity**: M

### ~~DEVOPS-03: Implement container lifecycle manager~~ DONE

**Status**: Completed (PR #52, merged 2026-02-19)
**Role**: DevOps
**Description**: Build the system that spawns agent containers on demand, manages
their lifecycle (start → running → shutdown), handles graceful and forced termination,
and cleans up resources (ZeroMQ sockets, temp files) on teardown. Detect and terminate
orphaned containers on host restart. Initially Docker-based.
**Dependencies**: DEVOPS-01, ENG-06
**Test requirements**: QA-09 (mock container runtime). Test: spawn, graceful shutdown,
forced kill after 10s timeout, resource cleanup, orphan detection on startup.
**Acceptance criteria**: Containers spawn with correct mounts and isolation. Graceful
shutdown signals are sent before forced kill. ZeroMQ sockets are cleaned up. Container
logs are captured. Stale/orphaned containers are detected and cleaned on startup.
**Complexity**: L

### ~~DEVOPS-04: Implement ZeroMQ socket provisioning~~ DONE

**Status**: Completed (PR #54, merged 2026-02-19)
**Role**: DevOps
**Description**: Build the system that creates, configures, and manages ZeroMQ Unix
domain sockets. Handle socket file creation, permissions, cleanup on shutdown, and
mounting into containers. Ensure sockets are only accessible by the host process and
the target container. Detect socket path collisions for concurrent sessions.
**Dependencies**: ENG-01, ENG-02, DEVOPS-01
**Acceptance criteria**: Socket files are created with restricted permissions. Sockets
are mounted into containers at the correct path. Stale socket files are cleaned up on
startup. Socket paths are configurable. Collisions for concurrent sessions are handled.
**Complexity**: M

### ~~DEVOPS-07: Create Docker Compose for local development~~ DONE

**Status**: Completed (PR #49, merged 2026-02-19)
**Role**: DevOps
**Description**: Create a `docker-compose.yml` that orchestrates the host core process
and agent container for local testing. Developers need a one-command way to spin up the
full system. Includes volume mounts for live-reload of skill files, socket sharing via
shared volume, and a dev network (bridge, no external access for the container).
**Dependencies**: DEVOPS-01, ENG-03
**Acceptance criteria**: `docker compose up` launches the full system. Skill file
changes are reflected without rebuild. Socket sharing works. Container has no external
network access. Developer can observe message flow.
**Complexity**: S

### ~~DEVOPS-08: Add container build and scan to CI~~ DONE

**Status**: Completed (PR #57, merged 2026-02-19)
**Role**: DevOps
**Description**: Extend CI pipeline to build the container image, scan it for OS-level
vulnerabilities (Trivy), and run a container smoke test (starts, filesystem is
read-only, network is unreachable, only `ipc` is executable). Optionally publish the
image to a registry on tagged releases.
**Dependencies**: DEVOPS-01, DEVOPS-02
**Acceptance criteria**: CI builds container image. Trivy scan runs and reports
vulnerabilities. Smoke test validates container constraints. High/critical Trivy
findings block merge.
**Complexity**: M

### ~~DEVOPS-10: Implement container permission lockdown (Layer 2)~~ DONE

**Status**: Completed (PR #29, merged 2026-02-19)
**Role**: DevOps
**Description**: Generate and mount the Claude Code `settings.json` file as a read-only
overlay in the container at `/home/node/.claude/settings.json`. This file restricts
Bash commands to only the `ipc` binary. Also mount `CLAUDE.md` (agent instructions)
and `skills/` directory as read-only overlays. The writable `.claude/` directory mount
must NOT override the read-only `settings.json` overlay.
**Dependencies**: DEVOPS-01
**Acceptance criteria**: `settings.json` is read-only inside the container. Claude
Code's Bash is restricted to `ipc` only. Agent cannot modify `settings.json`,
`CLAUDE.md`, or skill files. The `ipc` binary cannot be overwritten. `.claude/`
subdirectories for session data are writable.
**Complexity**: M

### ~~DX-01: Define plugin handler interface~~ DONE

**Status**: Completed (PR #28, merged 2026-02-19)
**Role**: DX Advocate
**Description**: Design and implement the TypeScript interface that all plugin handlers
must implement: `init(services: CoreServices)`, `handleToolInvocation(tool, args,
context)`, `shutdown()`. Include typed context (group, session, correlation). Export as
a public API for plugin authors. Define actionable error message template standard:
`[COMPONENT] Error: {what}. Fix: {how}. Docs: {link}`.
**Dependencies**: ARCH-03, ARCH-02
**Acceptance criteria**: Interface is clear and minimal. TypeScript provides full
autocomplete for plugin authors. Context includes all necessary fields. A sample "echo"
plugin can be written in under 30 lines and ships as `examples/echo-plugin/`. Error
message template is documented and enforced.
**Complexity**: M

### ~~DX-02: Build CLI entry point~~ DONE

**Status**: Completed (PR #58, merged 2026-02-19)
**Role**: DX Advocate
**Description**: Implement the main `carapace` CLI with subcommands: `start` (launch
core + container), `stop` (graceful shutdown), `status` (show running sessions),
`doctor` (check dependencies and configuration). Use a CLI framework (commander or
yargs).
**Dependencies**: ENG-03, DEVOPS-03
**Acceptance criteria**: `carapace start` launches the system. `carapace stop` shuts
down gracefully. `carapace status` shows active sessions. `carapace doctor` reports
missing dependencies.
**Complexity**: M

### ~~DX-06: Build plugin test SDK~~ DONE

**Status**: Completed (PR #41, merged 2026-02-19)
**Role**: DX Advocate
**Description**: Build a lightweight SDK for plugin authors to unit test their handlers
in isolation — no ZeroMQ, no running core, no containers. Includes:
`createTestContext(overrides?)` for mock PluginContext, `createTestInvocation(tool,
args)` to simulate tool calls against a handler, `FakeCredentialStore` for testing
without real secrets, response assertion helpers to verify shape and check for
accidental credential leakage.
**Dependencies**: DX-01, QA-02
**Acceptance criteria**: Plugin authors can
`import { createTestContext, createTestInvocation } from '@carapace/testing'` and
write a handler unit test in under 20 lines. No real ZeroMQ or core process needed.
**Complexity**: M

### ~~QA-04: Build integration test harness~~ DONE

**Status**: Completed (PR #55, merged 2026-02-19)
**Role**: QA
**Description**: Create a test harness that spins up real ZeroMQ sockets (in-process,
not Docker) for integration testing. Support sending wire messages and asserting on
envelope construction, routing, and responses. Include helpers for plugin registration
and session simulation. Cover: full 6-stage validation pipeline traversal, Response
Path testing (sanitize → log → forward), event bus → spawn decision logic (mock
container runtime), plugin initialization failure degradation, shutdown sequence
(drain → shutdown → cleanup).
**Dependencies**: QA-01, QA-03, QA-09, ENG-01, ENG-02, ENG-03
**Acceptance criteria**: Integration tests use real ZeroMQ sockets with in-process
communication. Tests can send wire messages and verify routing through all 6 stages.
Response Path is testable end-to-end. Test setup/teardown is clean (no socket leaks).
Tests run in CI without Docker.
**Complexity**: L

### ~~QA-05: Build plugin conformance test suite~~ DONE

**Status**: Completed (PR #44, merged 2026-02-19)
**Role**: QA
**Description**: Create a reusable test suite that validates any plugin against its
manifest contract. Verify: manifest parses correctly, declared tools are callable, tool
argument schemas match handler expectations, risk levels are honored, and lifecycle
hooks work. Plugin authors can run conformance tests on their own plugins.
**Dependencies**: QA-01, ENG-04, ENG-07, ARCH-03
**Acceptance criteria**: Running conformance tests against a valid plugin passes.
Running against a broken plugin produces specific, actionable failures. Plugin authors
can run: `pnpm test:conformance -- plugins/my-plugin/`.
**Complexity**: M

### ~~ENG-23: Implement container entrypoint wrapper for credential injection~~ DONE

**Status**: Completed (PR #43, merged 2026-02-19)
**Role**: Engineer
**Description**: Build a shell entrypoint script (`container/entrypoint.sh`) that runs
inside the container before `claude`. The script reads two lines from stdin (key name,
then value), exports the key as an environment variable, and `exec`s into `claude
--dangerously-skip-permissions`. This is the stdin-based credential injection pattern
adapted from nanoclaw. Credentials never appear in `docker inspect`, never in the
Dockerfile, and never mounted as files. The host-side container lifecycle manager
(DEVOPS-03) is responsible for writing the credential to the container's stdin at
spawn time.

Entrypoint logic:

1. Read key name from stdin (e.g. `ANTHROPIC_API_KEY` or `CLAUDE_CODE_OAUTH_TOKEN`)
2. Read value from stdin
3. Export key=value into the process environment
4. Close stdin (no further reads)
5. `exec claude --dangerously-skip-permissions "$@"`

Security properties: credentials exist only in the `claude` process environment (not in
Docker metadata, not on disk, not in `/proc` from outside the container's PID
namespace). Combined with DEVOPS-10 (Bash restricted to `ipc` only), Claude cannot run
`env`, `printenv`, or any other command to inspect its own environment.
**Dependencies**: DEVOPS-01, DEVOPS-10
**Test requirements**: QA-01. Test: entrypoint reads two lines and exports correctly,
missing stdin produces clear error, empty value is rejected, key name is validated
against allowlist (`ANTHROPIC_API_KEY`, `CLAUDE_CODE_OAUTH_TOKEN`), entrypoint exec's
into claude (not a subprocess).
**Acceptance criteria**: Entrypoint reads credentials from stdin and exports to env.
Invalid key names rejected. `claude` is exec'd (PID 1 in container). Credentials not
visible via `docker inspect`. Works with both API key and OAuth token credential types.
**Complexity**: S

### ~~DX-14: Implement `carapace auth` CLI commands~~ DONE

**Status**: Completed (PR #89, merged 2026-02-19)
**Role**: DX Advocate
**Description**: Add `carapace auth` subcommand group to the CLI (extends DX-02):

- `carapace auth api-key` — prompts for Anthropic API key, validates it with a
  lightweight API call (e.g. `GET /v1/models`), stores at
  `$CARAPACE_HOME/credentials/anthropic-api-key` with 0600 permissions.
- `carapace auth login` — guides the user through Max/Pro plan OAuth setup. Tells user
  to run `claude setup-token` in a separate terminal, then paste the resulting token.
  Stores at `$CARAPACE_HOME/credentials/claude-oauth-token` with 0600 permissions.
- `carapace auth status` — shows which credential is configured (API key vs OAuth
  token), whether it appears valid (not expired), and when it was last updated. Never
  prints the actual credential value.

At container spawn time, the host reads whichever credential file exists (API key takes
precedence if both are present) and sends it via stdin to the container entrypoint
(ENG-23). Credential files live in `$CARAPACE_HOME/credentials/` (directory 0700,
files 0600), created by SEC-18's `ensureDirectoryStructure()`.
**Dependencies**: DX-02, ENG-20, SEC-18
**Test requirements**: QA-01. Test: API key prompt and storage, OAuth token prompt and
storage, validation call (mock HTTP), status display for each type, file permissions
enforced, no credential value in status output, precedence when both exist.
**Acceptance criteria**: Both auth paths work end-to-end. Credentials stored with
correct permissions. Validation catches obviously invalid credentials before storing.
Status command shows auth state without leaking values. Works on macOS and Linux.
**Complexity**: M

### ~~DEVOPS-19: Update Dockerfile for Claude Code and entrypoint wrapper~~ DONE

**Status**: Completed (PR #48, merged 2026-02-19)
**Role**: DevOps
**Description**: Update the agent container Dockerfile (DEVOPS-01) to include Claude
Code CLI installation and the entrypoint wrapper (ENG-23). Changes:

1. Install Claude Code CLI (`npm install -g @anthropic-ai/claude-code`) in a build
   stage, copy to runtime stage
2. Copy `container/entrypoint.sh` as the container `ENTRYPOINT`
3. Configure network access for the Anthropic API (container needs outbound HTTPS to
   `api.anthropic.com` for LLM inference)
4. Keep the existing read-only root filesystem, `ipc` binary, skill file mounts

This is a deviation from the original architecture doc which specified "no network
access" for the container. The reality is that Claude Code needs to reach the LLM API.
DEVOPS-10 (Bash restricted to `ipc` only) is the primary mitigation — even with
network access, Claude cannot run `curl`, `wget`, or any other network tool.
**Dependencies**: DEVOPS-01, ENG-23, DEVOPS-10
**Test requirements**: QA-09. Test: container builds successfully, claude CLI is
available, entrypoint invokes claude, network reaches api.anthropic.com, read-only
filesystem still enforced, ipc binary still works.
**Acceptance criteria**: Container builds with Claude Code installed. Entrypoint
wrapper is the container entrypoint. Claude Code can reach Anthropic API. All existing
container security properties (read-only FS, ipc binary, skill mounts) preserved.
**Complexity**: M

### ~~DEVOPS-20: Implement container network allowlisting~~ DONE

**Status**: Completed (PR #61, merged 2026-02-19)
**Role**: DevOps / Security
**Description**: Restrict the container's network access to only the Anthropic API.
For the demo milestone, the container has full network access (DEVOPS-19). This task
hardens the network posture:

- Create a custom Docker network with iptables rules that allow only outbound HTTPS
  (port 443) to `api.anthropic.com` IP ranges
- Block all other outbound traffic (DNS is allowed to resolve the API hostname)
- Block all inbound traffic
- Update the container lifecycle manager (DEVOPS-03) to create and use this network
- Make the allowlist configurable in `config.toml` for future API endpoint changes

This is defense-in-depth: even if DEVOPS-10's Bash restriction is somehow bypassed,
the container still can't exfiltrate data to arbitrary hosts.
**Dependencies**: DEVOPS-19, DEVOPS-03, ENG-20
**Test requirements**: QA-01, QA-09. Test: API hostname resolves and is reachable,
non-allowlisted hosts are unreachable, inbound connections blocked, allowlist
configurable.
**Acceptance criteria**: Container can reach api.anthropic.com:443. Container cannot
reach any other host. DNS resolution works for allowlisted hostname. Allowlist is
configurable. Existing IPC (ZeroMQ over Unix socket) unaffected by network restrictions.
**Complexity**: M

---

## P1 — Installation Infrastructure

These tasks extend the existing P1 core functionality to support a working installable
system. They cover configuration management, container runtime abstraction, release
distribution, and installation paths.

### ~~ARCH-04: Define ContainerRuntime interface and adapter contracts~~ DONE

**Status**: Completed (PR #34, merged 2026-02-19)
**Role**: Architect
**Description**: Define the `ContainerRuntime` TypeScript interface and all supporting
types at `src/core/container/`: `ContainerRunOptions`, `ContainerHandle`,
`ContainerState`, `VolumeMount`, `SocketMount`, runtime name union type. Document
adapter behavioral differences (Podman SELinux mounts, Apple Container vsock sockets,
Docker reference behavior). Define the `detect()` function signature for auto-detection.
This is the contract that all adapters and DEVOPS-03 (lifecycle manager) consume. Move
existing `src/core/container-runtime.ts` (QA-09 mock) into `src/core/container/` and
update to implement the new interface.
**Dependencies**: ARCH-01, ARCH-02
**Test requirements**: QA-01. Type-level tests: interfaces compile, options are
exhaustive, ContainerHandle is opaque. QA-09 mock updated to new interface.
**Acceptance criteria**: Interface defined with full JSDoc. All three adapter behavioral
differences documented in code comments. `ContainerRunOptions` covers all mount types
including `SocketMount` for vsock. DEVOPS-03 and adapter tasks can proceed using this
interface. Mock container runtime (QA-09) moved to `src/core/container/` and updated to
implement the new interface.
**Complexity**: M

### ~~ARCH-05: Define configuration schema and CARAPACE_HOME resolution~~ DONE

**Status**: Completed (PR #31, merged 2026-02-19)
**Role**: Architect
**Description**: Design the configuration system: TypeScript types for the full
`config.toml` schema (runtime section with engine + image, plugins section with dirs,
security section with max_sessions_per_group, hello section with enabled flag), the
`$CARAPACE_HOME` resolution algorithm (env var → `~/.carapace/` default), and the
directory structure contract (which subdirectories exist, their permissions, mutable vs
immutable). Define the `CarapaceConfig` interface, `resolveHome()` function signature,
and `ensureDirectoryStructure()` contract. The config schema must be extensible for
future sections without breaking changes.
**Dependencies**: ARCH-01
**Test requirements**: QA-01. Test: resolution precedence (env > default), config schema
validates correctly, missing config file produces sensible defaults.
**Acceptance criteria**: Config type covers all sections from INSTALL_STRATEGY section 8.
`$CARAPACE_HOME` resolution is deterministic and documented. Directory structure contract
lists every subdirectory with purpose and permissions. Default config is defined for fresh
installs.
**Complexity**: M

### ~~ENG-20: Implement TOML config parser and path resolver~~ DONE

**Status**: Completed (PR #46, merged 2026-02-19)
**Role**: Engineer
**Description**: Implement the configuration system designed in ARCH-05. Parse
`config.toml` using a zero-dependency TOML library (e.g., `smol-toml`). Implement
`$CARAPACE_HOME` resolution. Validate parsed config against the schema. Provide typed
config access for all components. Create `ensureDirectoryStructure()` that creates
missing directories with correct permissions on startup (umask 077 for credential dirs).
Write and read the `version` file for install/update tracking.
**Dependencies**: ARCH-05
**Test requirements**: QA-01. Test: TOML parsing, schema validation, home resolution
precedence, directory creation with permissions, version file read/write, missing config
produces defaults, invalid config produces clear errors.
**Acceptance criteria**: `config.toml` is parsed and validated. `$CARAPACE_HOME` resolves
correctly across env var, default, and edge cases (trailing slashes, `~` expansion).
Missing directories created with correct permissions. `version` file maintained. All
path-dependent components can import and use the resolver.
**Complexity**: M

### ~~ENG-21: Extend plugin loader for dual-directory scanning~~ DONE

**Status**: Completed (PR #50, merged 2026-02-19)
**Role**: Engineer
**Description**: Modify the existing plugin loader (ENG-04) to scan two directories:
`$CARAPACE_HOME/lib/plugins/` (built-in, read-only) and `$CARAPACE_HOME/plugins/` (user,
mutable). User plugins override built-in plugins of the same name — if both directories
contain `reminders/`, only the user version is loaded. Each loaded plugin tagged with
source (`built-in` | `user`). The plugin list command can use this tag. Built-in
directory is optional (may not exist in dev mode).
**Dependencies**: ENG-04, ENG-20
**Test requirements**: QA-01, QA-02. Test: both directories scanned, user overrides
built-in, missing built-in dir is not an error, plugin source tag correct, override
logging.
**Acceptance criteria**: Plugins discovered from both directories. User plugins override
built-in by name. Each plugin has a source tag. Missing built-in directory doesn't crash.
Override events are logged. Existing plugin loader tests still pass.
**Complexity**: S

### ~~DEVOPS-12: Implement Docker container runtime adapter~~ DONE

**Status**: Completed (PR #40, merged 2026-02-19)
**Role**: DevOps
**Description**: Implement the `ContainerRuntime` interface (ARCH-04) for Docker.
Reference adapter — Docker is the most common runtime and the baseline for testing.
Implements all interface methods: `isAvailable()` (checks `docker` binary + daemon),
`version()`, `pull()`, `imageExists()`, `loadImage()` (for Nix-built tarballs), `run()`
(with volume mounts, network disabled, read-only root, env vars), `stop()`, `kill()`,
`remove()`, `inspect()`. Uses `child_process.execFile` to invoke Docker CLI — no Docker
SDK dependency.
**Dependencies**: ARCH-04
**Test requirements**: QA-01, QA-09. Unit tests with mock exec. Integration tests
(tagged, Docker-required) verify real Docker operations.
**Acceptance criteria**: All `ContainerRuntime` interface methods implemented. Unit tests
pass without Docker. Integration tests pass with Docker. Error handling covers: Docker
not installed, daemon not running, image not found, container already exists.
**Complexity**: M

### ~~DEVOPS-13: Implement Podman container runtime adapter~~ DONE

**Status**: Completed (PR #42, merged 2026-02-19)
**Role**: DevOps
**Description**: Implement `ContainerRuntime` for Podman. Handles Podman-specific
differences: `:Z` suffix on bind mounts for SELinux, `--userns=keep-id` for rootless
operation, minor `inspect` output format differences. Podman CLI is largely
Docker-compatible — reuses patterns established in DEVOPS-12 with targeted overrides.
**Dependencies**: ARCH-04, DEVOPS-12
**Test requirements**: QA-01, QA-09. Unit tests with mock exec. Integration tests
(tagged, Podman-required).
**Acceptance criteria**: All `ContainerRuntime` methods work with Podman. SELinux mount
flags applied on Linux. Rootless operation works. Tests cover Podman-specific edge cases.
**Complexity**: S

### ~~DEVOPS-14: Implement container runtime auto-detection~~ DONE

**Status**: Completed (PR #51, merged 2026-02-19)
**Role**: DevOps
**Description**: Build the auto-detection module at `src/core/container/detect.ts`.
Checks for available container runtimes in priority order: (1) user config preference
from `config.toml`, (2) Apple Containers (macOS 26+ with Apple Silicon), (3) Podman,
(4) Docker. Returns the first available runtime adapter. Detection result includes
`isolationLevel: 'vm' | 'namespace' | 'rootless-namespace'` based on runtime AND
platform (Docker on macOS = vm via Docker Desktop VM, Docker on Linux = namespace, Podman
rootless = rootless-namespace, Apple Containers = vm). Provides `detectRuntime(config?)`
and `listAvailableRuntimes()` — interactive selection when multiple runtimes are found
is a CLI concern (DX-02), not the library.
**Dependencies**: ARCH-04, ENG-20, DEVOPS-12
**Test requirements**: QA-01. Test: single runtime found → auto-select, multiple found →
priority order, user preference overrides detection, no runtime found → clear error,
isolation level correctly determined per runtime+platform combination, detection failure
is not a crash.
**Acceptance criteria**: Detection correctly identifies available runtimes. Priority order
is enforced. User preference in config overrides detection. No runtime found produces an
actionable error message. Detection result includes `isolationLevel` field — `carapace
doctor` displays this prominently. Detection completes in < 2s.
**Complexity**: S

### ~~DEVOPS-15: Build release pipeline (GitHub Actions)~~ DONE

**Status**: Completed (PR #86, merged 2026-02-19)
**Role**: DevOps
**Description**: Create GitHub Actions workflow triggered on tagged releases. Produces:
(1) platform-specific tarballs via build matrix (macOS arm64/x86_64, Linux
x86_64/arm64) — each containing compiled TypeScript `dist/`, production `node_modules/`
with pre-built native ZeroMQ addons, `carapace` wrapper script, and version file;
(2) SHA-256 checksums for all tarball artifacts; (3) multi-arch container image
(linux/amd64, linux/arm64) pushed to GHCR at
`ghcr.io/fred-drake/carapace-agent:v{version}`; (4) cosign keyless signing of container
image via Sigstore/GitHub Actions OIDC; (5) image digest pinned in release notes;
(6) SBOM (CycloneDX format) generated and published alongside tarballs. All artifacts
uploaded to GitHub Releases. Security hardening: all CI actions pinned to commit SHA (not
tag), checksums generated in same workflow as builds, cosign signature verified
post-publish as CI check. Native ZeroMQ addon build strategy documented with security
trade-off analysis (prebuild vs from-source).
**Dependencies**: DEVOPS-01, DEVOPS-02, DEVOPS-09
**Test requirements**: Workflow runs on tag push. Checksums verifiable offline. Cosign
signature verifiable. Multi-arch image pulls on both architectures. Post-publish
verification passes. SBOM validates against CycloneDX schema.
**Acceptance criteria**: Tagged push triggers full build matrix. Tarballs correctly
structured with working native addons per platform. SHA-256 checksums published. Container
image signed with cosign (keyless). Image digest in release notes. Multi-arch works.
Post-publish signature verification passes. All CI actions pinned to SHA. SBOM published
with each release. Native addon build strategy documented.
**Complexity**: L

### ~~DEVOPS-16: Implement install script (scripts/install.sh)~~ DONE

**Status**: Completed (PR #91, merged 2026-02-19)

**Role**: DevOps / DX
**Description**: Write POSIX `#!/bin/sh` install script — no bashisms, runs on macOS and
Linux. Platform detection (OS, architecture, available container runtimes). Downloads
release tarball from GitHub Releases over HTTPS. Verifies SHA-256 checksum (fail-closed:
mismatch aborts immediately). Extracts to `$CARAPACE_HOME` (default `~/.carapace/`) using
transactional install (extract to `$CARAPACE_HOME/.installing/`, verify, atomic move to
final location; partial failure rolls back completely). Pulls container image from GHCR.
Verifies cosign signature on container image. Sets credential directory permissions
(umask 077). Adds `bin/carapace` to PATH for bash/zsh/fish (with `--no-modify-path`
opt-out). Respects `$HTTPS_PROXY` / `$HTTP_PROXY` for downloads, passes proxy env to
container runtime for image pulls.

Interactive UX: boxed header with version, progress indicators, clear success/failure
messages, platform-specific next steps. When Node.js is missing, shows platform-specific
install commands ordered by detected package manager (brew on macOS, apt/dnf on Linux,
nvm/fnm cross-platform). Shell PATH detection: macOS defaults to `~/.zshrc`, uses
`~/.bash_profile` (not `.bashrc`) for bash; Linux uses `~/.bashrc` for bash, `~/.zshrc`
for zsh; Fish uses `fish_add_path` in `~/.config/fish/config.fish`. Interactive mode asks
PATH confirmation; non-interactive prints what to add manually. Existing install detection:
if `~/.carapace/` exists, shows installed version and offers upgrade/reinstall/cancel;
`--yes` treats as upgrade.

Flags: `--dry-run`, `--yes` (non-interactive), `--no-modify-path`,
`--runtime docker|podman|apple`, `--version v1.2.3`. Detects piped execution
(`[ -t 0 ]`) and switches to non-interactive mode with info notice.

Security hardening: `umask 077` as first executable line, `SCRIPT_VERSION` variable at
top, `mktemp -d` with `trap 'rm -rf "$TMPDIR"' EXIT INT TERM` for cleanup, `install -d
-m 0700` for credential directory (atomic, no TOCTOU race), no world-readable
intermediate files, artifact verification in ALL modes (piped and interactive) with no
bypass path, no `--skip-verify` flag, fail-closed on checksum or digest mismatch, piped
execution shows notice: "Running in non-interactive mode. For verified install, see...",
container image digest sourced from the verified checksum file (not fetched separately).
Never calls sudo.
**Dependencies**: DEVOPS-15
**Test requirements**: shellcheck clean (zero warnings). Test on macOS and Linux. Test
piped vs interactive modes. Test each flag combination. Test checksum failure aborts
cleanly. Test trap cleanup removes partial installs. Test existing install detection.
Test proxy variable passthrough.
**Acceptance criteria**: Installs Carapace from GitHub Releases. Checksum + cosign
verification passes. Platform detection correct on all 4 platform/arch combinations. All
flags work correctly. PATH modification correct for bash/zsh/fish with per-platform
defaults. Interactive UX matches INSTALL_STRATEGY section 5 mockup. Zero sudo. shellcheck
clean. Piped execution works non-interactively. Failed verification cleans up partial
install and exits non-zero. Transactional install: partial failure (e.g. image pull fails)
rolls back completely. Existing install detected and handled (upgrade/reinstall/cancel).
Proxy variables respected. Node.js prerequisite shows platform-specific install commands.
All security hardening requirements met (umask, trap, atomic ops, fail-closed, no eval).
**Complexity**: L

### ~~SEC-15: Implement install script security hardening and review~~ DONE

**Status**: Completed (PR #94, merged 2026-02-19)
**Role**: Security
**Description**: Security review and hardening of the install script (DEVOPS-16). Verify:
(1) no `eval` or indirect execution of downloaded content, (2) all downloads HTTPS-only
with certificate validation, (3) fail-closed checksum verification (mismatch → immediate
abort, no fallback), (4) atomic directory operations (temp dir → verify → mv, never
in-place), (5) trap-based cleanup removes partial installs on any failure, (6) umask 077
for credential directory creation, (7) proper shell quoting throughout (no word splitting
vulnerabilities), (8) piped execution detection prevents interactive prompts in
non-interactive mode, (9) socket path validation rejects symlinks (prevent IPC redirect
to attacker-controlled endpoint). Write security-specific test cases for each vector.
Sign off required before release.
**Dependencies**: DEVOPS-16
**Test requirements**: Automated test suite covering each security vector. Test: MITM
resistance (HTTPS-only), checksum tamper detection, partial install cleanup, quoting
safety, piped mode safety, socket path symlink rejection.
**Acceptance criteria**: Install script passes all security tests. No eval of remote
content. HTTPS enforced. Checksum mismatch aborts immediately. Partial installs cleaned
up on failure. Shell quoting is safe. Socket paths validated against symlinks. Security
sign-off documented.
**Complexity**: M

### ~~SEC-16: Implement release artifact verification library~~ DONE

**Status**: Completed (PR #90, merged 2026-02-19)
**Role**: Security
**Description**: Build reusable verification functions used by the install script
(DEVOPS-16), update command (DX-09), and `carapace doctor` (DEVOPS-05): (1) SHA-256
checksum verification for tarballs, (2) cosign signature verification for container
images (shell out to `cosign verify`), (3) container image digest comparison against
pinned value in config. Functions return structured results (pass/fail with reason), not
just booleans. Failure messages include remediation steps. For the install script (POSIX
sh), provide shell function equivalents. For the TypeScript runtime, provide a
`@carapace/verify` module.
**Dependencies**: DEVOPS-15, ENG-20
**Test requirements**: QA-01. Test: valid checksum passes, tampered checksum fails with
clear error, valid cosign signature passes, invalid/expired signature fails, digest match
passes, digest mismatch fails. Test with missing cosign binary (graceful degradation with
warning).
**Acceptance criteria**: Verification functions work in both POSIX sh (for install script)
and TypeScript (for runtime). All failure cases produce actionable error messages.
Missing cosign binary detected and reported (not a silent failure). Functions are reusable
across install, update, and doctor.
**Complexity**: M

### ~~SEC-17: Implement container image digest pinning~~ DONE

**Status**: Completed (PR #87, merged 2026-02-19)
**Role**: Security
**Description**: Implement digest-based container image pinning to prevent tag-based
supply chain attacks. (1) Store image reference as `image@sha256:...` in `config.toml`
(not just `image:tag`). (2) On every container pull, verify the pulled digest matches the
pinned value. (3) During `carapace update`, atomically update the pinned digest after
verifying the new image's cosign signature. (4) `carapace doctor` reports whether the
current image matches the pinned digest. (5) Refuse to run a container whose digest
doesn't match config (fail-closed).
**Dependencies**: ENG-20, DEVOPS-12, DEVOPS-15
**Test requirements**: QA-01. Test: digest match allows run, digest mismatch blocks run,
update atomically changes pinned digest, doctor reports mismatch, tag-only reference
rejected.
**Acceptance criteria**: Container image references use digest pinning in config. Digest
mismatch prevents container launch with clear error. Update command atomically updates
pinned digest. Doctor reports digest status. Tag-only references are rejected with
guidance to use digest.
**Complexity**: M

### ~~SEC-18: Implement credential directory security model~~ DONE

**Status**: Completed (PR #80, merged 2026-02-19)
**Role**: Security
**Description**: Define and enforce the security model for `$CARAPACE_HOME/credentials/`:
directory permissions 0700, file permissions 0600, ownership validation, no symlink
following (prevent symlink attacks), no world-readable files. Verify permissions on every
startup (not just install). `carapace doctor` checks and reports on credential directory
security. Warn if running as root. Integration with `ensureDirectoryStructure()` from
ENG-20 for initial creation.
**Dependencies**: ENG-20, DEVOPS-05
**Test requirements**: QA-01. Test: permissions enforced on creation, symlink rejected,
permission drift detected on startup, root warning, doctor integration.
**Acceptance criteria**: Credential directory created with 0700. Files within created
with 0600. Symlink attacks prevented (no symlink following). Permissions verified on
every startup. Doctor reports credential directory status. Root warning displayed when
applicable.
**Complexity**: S

### ~~DX-11: Rewrite README.md for end users + create CONTRIBUTING.md~~ DONE

**Status**: Completed (PR #96, merged 2026-02-19)
**Role**: DX Advocate
**Description**: Split current developer-focused README into two documents: (1)
`README.md` — user-focused: what Carapace is, security model overview, both install paths
(Nix flake and install script), quick start guide, links to full docs. (2)
`CONTRIBUTING.md` — developer-focused: dev environment setup (Nix flake, direnv), build
and quality commands, TDD discipline, PR workflow, plugin authoring pointer. Must be ready
when install infrastructure ships — the README is the GitHub landing page and first
touchpoint for new users.
**Dependencies**: DEVOPS-16, DEVOPS-18
**Test requirements**: Review: install commands work as documented on both paths.
**Acceptance criteria**: README.md is user-focused with working install instructions for
both Nix and script paths. CONTRIBUTING.md covers complete dev setup. Current developer
content from README preserved in CONTRIBUTING.md.
**Complexity**: S

### ~~DX-13: Implement post-install onboarding flow~~ DONE

**Status**: Completed (PR #60, merged 2026-02-19)
**Role**: DX Advocate
**Description**: Build the guided first-run experience that activates when `carapace
doctor` detects no `config.toml` (fresh install). Flow: (1) confirm detected container
runtime or select from available options, (2) write initial `config.toml` with selected
runtime, (3) run smoke test using `hello.greet` to verify IPC pipeline end-to-end, (4)
display "Getting Started" tips (next commands, how to add plugins, link to docs). This
bridges the gap between "install completed" and "user is productive." Skipped in
non-interactive mode (`--yes` flag).
**Dependencies**: DX-02, ENG-20, ENG-22, DEVOPS-14
**Test requirements**: QA-01. Test: fresh install triggers onboarding, existing config
skips it, runtime selection works, smoke test runs, non-interactive mode skips.
**Acceptance criteria**: Fresh install triggers guided onboarding. Runtime detected and
confirmed with user. Initial config written. Smoke test verifies IPC pipeline. Getting
Started tips displayed. Non-interactive mode skips gracefully. User can re-run via
`carapace setup`.
**Complexity**: S

---

## P2 — Features & Hardening

These tasks add the first real plugin, developer tooling, security hardening,
adversarial testing, and the Claude Code e2e test infrastructure.

### ~~ENG-10: Implement memory plugin — data layer~~ DONE

**Status**: Completed (PR #63, merged 2026-02-19)
**Role**: Engineer
**Description**: Build the SQLite schema and data access layer for the memory plugin:
entries table (typed: preference, fact, instruction, context, correction), FTS5
full-text search index, provenance tracking (source session, timestamp, group).
Migrations for schema creation.
**Dependencies**: ENG-08, ARCH-02
**Test requirements**: QA-01, QA-02 (SQLite test helpers). Test: CRUD operations, FTS5
search ranking, provenance auto-fill, supersession chain handling, purge of old
superseded entries.
**Acceptance criteria**: Memory entries can be stored, searched (FTS5), and deleted.
Entry types are enforced. Provenance fields are populated automatically. Search returns
ranked results. `PRAGMA journal_mode=WAL` set during init. `PRAGMA user_version`
checked — refuse to start if DB version > handler version. Superseded entry purge
runs during `initialize()`. Group name validation enforced at DB path construction.
**Complexity**: M

### ~~ENG-11: Implement memory plugin — tool handlers~~ DONE

**Status**: Completed (PR #67, merged 2026-02-19)
**Role**: Engineer
**Description**: Build the four memory tool handlers: `memory_store` (create entry),
`memory_search` (FTS5 query), `memory_brief` (summarize recent/relevant entries for
session start), `memory_delete` (remove entry by ID). Each validates arguments against
schema.
**Dependencies**: ENG-10, DX-01, ENG-07
**Test requirements**: QA-01, QA-02. Test each handler: valid args pass, invalid
rejected, rate limits enforced, response format matches spec.
**Acceptance criteria**: All four tools work end-to-end. Arguments are validated.
Responses match documented format. Handler-enforced rate limits: max 20
`memory_store`, 5 `supersedes`, 5 `memory_delete` per session. `behavioral` flag
derived from `type` (never agent-supplied). Provenance fields populated from envelope
(session_id, group, timestamp) — never from arguments.
**Complexity**: L

### ~~ENG-12: Implement memory plugin — skill file~~ DONE

**Status**: Completed (PR #71, merged 2026-02-19)
**Role**: Engineer
**Description**: Write the container-side skill markdown file that teaches Claude about
the memory tools. Document each tool's purpose, arguments, examples, and when to use
it. Follow the skill file conventions established by DX. Include `ipc` invocation
examples.
**Dependencies**: ENG-11, ENG-09
**Acceptance criteria**: Skill file accurately describes all four tools. Includes usage
examples with `ipc` invocations. Claude can invoke memory tools correctly when given
this skill file.
**Complexity**: S

### ~~ENG-13: Implement memory brief hook~~ DONE

**Status**: Completed (PR #72, merged 2026-02-19)
**Role**: Engineer
**Description**: Build the event-driven hook that fires on `agent.started` events.
When a new session begins, the memory plugin automatically runs `memory_brief` and
injects the result into the agent's context. This gives the agent relevant memories
without being asked.
**Dependencies**: ENG-11, ENG-01, ENG-06, DEVOPS-03
**Test requirements**: QA-01, QA-02, QA-09. Test: brief generation, behavioral/non-
behavioral sorting, newline stripping (all variants: `\r\n`, `\r`, Unicode U+2028,
U+2029), max_brief_entries limit (default 50), max_brief_chars limit (default 10000),
5-second timeout behavior (core-enforced), empty group produces no brief, superseded
entries excluded from brief.
**Acceptance criteria**: On session start, memory brief is generated and available to
the agent. Brief includes relevant entries for the session's group. Behavioral entries
sorted before non-behavioral with warning block. Newline stripping prevents markdown
injection. Config limits honored (whichever hit first). 5-second timeout is
core-enforced. Empty groups produce no brief (not an error). Superseded entries
excluded.
**Complexity**: M

### ~~SEC-04: Implement group-level authorization~~ DONE

**Status**: Completed (PR #65, merged 2026-02-19)
**Role**: Security
**Description**: Build the authorization layer that ensures plugins only receive
messages for their authorized groups. The core checks the session's group against the
plugin's allowed groups before routing. Prevent cross-group data access in multi-group
scenarios.
**Dependencies**: SEC-01, ENG-06
**Acceptance criteria**: A plugin registered for group A never receives messages from
group B. Authorization checks happen in the router before dispatch. Unauthorized
attempts are logged with full context.
**Complexity**: M

### ~~SEC-05: Build security test suite~~ DONE

**Status**: Completed (PR #62, merged 2026-02-19)
**Role**: Security / QA
**Description**: Create a dedicated security test suite covering: wire format fuzzing,
identity spoofing attempts, cross-group access, rate limit boundary testing, credential
leak detection. Enumerate specific fuzzing scenarios: oversized JSON payload (1MB+),
deeply nested JSON (100+ levels), Unicode edge cases in topic names, empty/null/
undefined values in every field, prototype pollution attempts (`__proto__`,
`constructor.prototype`, `toString`), path traversal in group names, concurrent
session isolation, ZeroMQ connection identity spoofing, shutdown race conditions
(messages during drain phase), ToolError instanceof manipulation, error message
information leakage.
**Dependencies**: QA-04, SEC-01, SEC-02, SEC-03
**Test requirements**: Run as `pnpm test:security`. Tagged separately from unit tests.
**Acceptance criteria**: All documented security boundaries have corresponding tests.
Each fuzzing scenario is tested. Spoofing attempts are provably blocked. Concurrent
sessions proven isolated. Tests run in CI on every push.
**Complexity**: L

### ~~SEC-06: Implement memory entry security model~~ DONE

**Status**: Completed (PR #68, merged 2026-02-19)
**Role**: Security
**Description**: Build the untrusted-by-default model for memory entries: behavioral
flags (derived from `type`, not agent-supplied), provenance tracking (immutable after
creation), read-side security gates (skepticism instructions for untrusted entries).
Cover: newline stripping completeness (all markdown injection variants including
Unicode line separators), content length enforcement with storage growth bounds,
supersedes chain depth limits, behavioral flag derivation integrity (wire format
cannot override), FTS5 ranking manipulation resistance.
**Dependencies**: ENG-10
**Acceptance criteria**: Memory entries have behavioral flags derived from type.
Provenance is immutable after creation. Read-side gates inject skepticism instructions.
Entries from different groups are isolated. All newline variants stripped. Supersedes
chain depth is bounded. Wire format cannot influence behavioral flag.
**Complexity**: M

### ~~SEC-09: Implement supply chain security pipeline~~ DONE

**Status**: Completed (PR #85, merged 2026-02-19)
**Role**: Security / DevOps
**Description**: Integrate dependency and supply chain security into CI: (1) `pnpm
audit --audit-level=high` on every push, (2) Socket.dev for supply chain risk
analysis (typosquatting, install scripts, network access in packages), (3) lockfile
integrity verification (ensure pnpm-lock.yaml matches package.json), (4) GitHub secret
scanning enabled on the repo. Block merges on critical/high vulnerabilities.
**Dependencies**: DEVOPS-02
**Acceptance criteria**: CI pipeline includes dependency scanning. Critical
vulnerabilities block merge. Secret scanning catches credential patterns in commits.
Lockfile integrity is verified.
**Complexity**: M

### ~~SEC-11: Implement SQLite and FTS5 injection testing~~ DONE

**Status**: Completed (PR #73, merged 2026-02-19)
**Role**: Security / QA
**Description**: Verify that all SQLite operations use parameterized queries and cannot
be injected. FTS5 has its own query syntax — test: (1) SQL injection through memory
content, tags, and search query fields, (2) FTS5 query syntax injection (NEAR, AND,
OR, column filters), (3) path traversal in group names used for SQLite file paths,
(4) PRAGMA injection attempts.
**Dependencies**: ENG-10, SEC-06
**Acceptance criteria**: All DB operations use parameterized queries (verified by code
review + Semgrep rule). FTS5 query injection attempts are neutralized. Group name
validation rejects traversal patterns. Tests cover each vector.
**Complexity**: M

### ~~SEC-12: Build adversarial e2e security test framework~~ DONE

**Status**: Completed (PR #100, merged 2026-02-19)
**Role**: Security / QA
**Description**: Build a framework for adversarial e2e testing that exercises the full
attack surface through real agent sessions. Scenarios: (1) prompt injection via inbound
message, (2) memory poisoning — store malicious behavioral instruction, verify brief
flags it, (3) identity spoofing via crafted wire messages, (4) tool enumeration —
invoke undeclared tools, (5) rate limit exhaustion — flood invocations, (6) credential
probing — check responses for leaked credentials, (7) container escape attempts —
access network, modify settings.json, execute arbitrary binaries.
**Dependencies**: SEC-05, QA-06, SEC-07, QA-08
**Test requirements**: Run as tagged `security-e2e` tests, separate from unit tests.
**Acceptance criteria**: Each adversarial scenario has an automated test. All attacks
are provably contained. Test report maps scenarios to defense layers. Tests run in CI
on merge to main.
**Complexity**: XL

### ~~SEC-13: Implement audit log integrity and security~~ DONE

**Status**: Completed (PR #74, merged 2026-02-19)
**Role**: Security
**Description**: Secure the audit log itself: (1) append-only (no modification/deletion
by plugins or handlers), (2) log entries include sequence numbers to detect tampering,
(3) log rotation with archive integrity, (4) audit log directory permissions prevent
container access, (5) sensitive data (credential patterns) never written to audit logs
even in error stack traces.
**Dependencies**: ENG-17, SEC-01
**Acceptance criteria**: Audit log cannot be modified after write. Tamper detection
catches deletions/modifications. Credential patterns are scrubbed from log entries.
Tests verify log integrity under normal and adversarial conditions.
**Complexity**: M

### ~~SEC-14: Write custom Semgrep SAST rules~~ DONE

**Status**: Completed (PR #75, merged 2026-02-19)

**Role**: Security / DevOps
**Description**: Write Carapace-specific Semgrep rules that encode security invariants
as code: (1) `no-identity-in-wire-format` — flag reading source/group/id from wire
input, (2) `require-additional-properties-false` — flag JSON Schema objects missing
it, (3) `parameterized-sqlite-queries` — flag string concatenation in query
construction, (4) `no-error-message-passthrough` — flag
`new ToolError({message: err.message})`, (5) `no-credentials-in-responses` — flag
env vars or config values in return objects, (6) `group-isolation` — flag direct DB
queries without group filter. Integrate into CI (blocks merge on findings).
**Dependencies**: DEVOPS-02
**Acceptance criteria**: At least 6 custom Semgrep rules running in CI. Violations
fail the build. Rules are documented with examples. False positives can be suppressed
via inline comments.
**Complexity**: M

### ~~DEVOPS-05: Implement health check system~~ DONE

**Status**: Completed (PR #69, merged 2026-02-19)
**Role**: DevOps
**Description**: Build `carapace doctor` that checks: Node.js version, pnpm
availability, Docker running, ZeroMQ library installed, SQLite available, plugin
directories valid, socket paths writable. Report clear pass/fail per check with fix
suggestions.
**Dependencies**: DX-02
**Acceptance criteria**: `carapace doctor` reports status of all dependencies. Failed
checks include actionable fix instructions. Exit code is non-zero if any check fails.
Works on macOS and Linux.
**Complexity**: M

### ~~DEVOPS-06: Implement log aggregation~~ DONE

**Status**: Completed (PR #66, merged 2026-02-19)
**Role**: DevOps
**Description**: Build structured logging for the core, plugins, and container output.
JSON-formatted logs with level, timestamp, component, and message. Route container
stdout/stderr to host logging. Support log level configuration.
**Dependencies**: ENG-03, DEVOPS-03
**Acceptance criteria**: All components log in structured JSON format. Container output
appears in host logs. Log levels are configurable (debug, info, warn, error). Logs
include component identification.
**Complexity**: M

### DEVOPS-09: Add Nix build output for host binary

**Role**: DevOps
**Description**: Extend `flake.nix` to include a `packages.default` output that builds
the host-side TypeScript into a deployable artifact (compiled JS + node_modules).
Currently the flake only defines a `devShell`. A build output enables `nix build` for
reproducible production builds.
**Dependencies**: ARCH-01
**Acceptance criteria**: `nix build` produces a runnable artifact. Output includes
compiled JS and pinned dependencies. Build is reproducible.
**Complexity**: M

### ~~DEVOPS-11: Implement e2e test CI infrastructure~~ DONE

**Status**: Completed (PR #99, merged 2026-02-19)
**Role**: DevOps / QA
**Description**: Build CI infrastructure for running Claude Code e2e tests: nightly
scheduled workflow, token/cost budget caps per run, result categorization (PASS,
DIFFERENT_PATH, REGRESSION, FLAKY, BUDGET_EXCEEDED), trend tracking across runs,
alerting on sustained pass-rate drops. These tests NEVER gate merges — they run on
schedule and produce reports.
**Dependencies**: DEVOPS-02, QA-08
**Acceptance criteria**: Nightly workflow runs e2e tests. Budget caps prevent runaway
costs. Results are categorized and stored. Trend dashboard shows pass-rate over time.
Alert fires if pass rate drops below threshold for N consecutive runs.
**Complexity**: L

### ~~DX-03: Build plugin scaffolding CLI~~ DONE

**Status**: Completed (PR #64, merged 2026-02-19)
**Role**: DX Advocate
**Description**: Add `carapace plugin create <name>` command that generates a new
plugin skeleton: `manifest.json` with placeholder tools, `handler.ts` with the
interface implemented, `skills/<name>.md` template, and a test file using the plugin
test SDK (DX-06). Interactive prompts for tool names and risk levels.
**Dependencies**: DX-01, DX-02, DX-06, ARCH-03
**Acceptance criteria**: `carapace plugin create my-plugin` creates a valid, buildable
plugin skeleton. Generated manifest validates. Generated handler compiles. Generated
test uses plugin test SDK and runs (fails per TDD — ready for implementation).
**Complexity**: M

### ~~DX-04: Build message tracing / debug mode~~ DONE

**Status**: Completed (PR #66, merged 2026-02-19)

**Role**: DX Advocate
**Description**: Add a debug mode that logs all messages flowing through the system:
wire messages received, envelopes constructed, routing decisions, plugin dispatch,
responses returned. Tap into ZeroMQ channels for real-time message inspection.
**Dependencies**: ENG-03, DX-02
**Acceptance criteria**: `carapace start --debug` shows all message flow. Messages are
pretty-printed with timestamps. Sensitive data (credentials) is redacted. Can filter
by topic or plugin.
**Complexity**: M

### ~~DX-05: Write plugin authoring guide~~ DONE

**Status**: Completed (PR #84, merged 2026-02-19)

**Role**: DX Advocate
**Description**: Create comprehensive documentation for plugin authors: manifest format
reference, handler interface guide, skill file conventions, testing guide (unit via
plugin test SDK, conformance via QA-05, integration via QA-04), and walkthroughs
building both the echo plugin (simple) and memory plugin (complex) from scratch.
**Dependencies**: ENG-12, DX-01, DX-03, DX-06, QA-05
**Acceptance criteria**: A developer unfamiliar with the codebase can build and test a
new plugin by following the guide. All code examples compile and work. Guide covers
error cases, debugging, and the full testing pyramid for plugins.
**Complexity**: M

### ~~DX-07: Implement plugin hot reload / watch mode~~ DONE

**Status**: Completed (PR #76, merged 2026-02-19)

**Role**: DX Advocate
**Description**: Add `carapace start --watch` that monitors `plugins/` for file
changes. On change: re-validate manifest, re-compile handler, re-register tools in
the router. Clear terminal output showing what was reloaded and success/failure.
**Dependencies**: DX-02, ENG-04
**Acceptance criteria**: Modifying a plugin handler and saving triggers automatic
reload within 2 seconds. Manifest errors during reload show actionable messages without
crashing the system.
**Complexity**: M

### ~~DX-08: Build manifest validation CLI command~~ DONE

**Status**: Completed (PR #77, merged 2026-02-19)

**Role**: DX Advocate
**Description**: Add standalone `carapace plugin validate [path]` that validates a
manifest without starting the system. Checks: JSON syntax, schema validity, tool name
uniqueness, `additionalProperties: false` on all argument schemas, skill file
existence, risk level warnings.
**Dependencies**: ARCH-03, DX-02
**Acceptance criteria**: `carapace plugin validate plugins/my-plugin/` returns
pass/fail with specific error messages. Exits non-zero on failure. Works without a
running core.
**Complexity**: S

### ~~QA-06: Build container lifecycle integration tests~~ DONE

**Status**: Completed (PR #88, merged 2026-02-19)

**Role**: QA
**Description**: Create integration tests that exercise the full container lifecycle:
spawn container, establish ZeroMQ connection, send tool invocations, receive responses,
and clean shutdown. These require Docker and run in CI but not in the normal unit test
suite.
**Dependencies**: QA-04, DEVOPS-03, ENG-05
**Test requirements**: Run as `pnpm test:e2e`. Docker-required, tagged separately.
**Acceptance criteria**: Tests cover: spawn, communication, graceful shutdown, forced
shutdown, stale/orphan cleanup. Tests are tagged to run separately from unit tests.
Tests clean up all containers on failure.
**Complexity**: L

### ~~QA-07: Implement coverage reporting and gates~~ DONE

**Status**: Completed (PR #68, merged 2026-02-19)
**Role**: QA
**Description**: Configure coverage collection (v8 via Vitest), set minimum coverage
thresholds, and add coverage gates to CI that block merges below thresholds. Generate
HTML coverage reports for local review.
**Dependencies**: QA-01, DEVOPS-02
**Acceptance criteria**: `pnpm test:coverage` generates reports. CI fails if coverage
drops below thresholds. Global: 80% line, 70% branch. Security-critical modules
(`src/core/router`, `src/core/validation`): 90% line, 80% branch. HTML reports are
generated for local review. Coverage excludes test files and type definitions.
**Complexity**: S

### ~~QA-08: Build Claude Code e2e test infrastructure~~ DONE

**Status**: Completed (PR #98, merged 2026-02-19)
**Role**: QA
**Description**: Build the test runner infrastructure for end-to-end tests driven by
Claude Code as an actual AI agent. These tests are non-deterministic — Claude Code
drives real agent sessions (spawn container, read skills, invoke tools via IPC, receive
responses). Infrastructure includes: scenario definition format (input prompt →
expected observable outcomes), semantic assertion library for non-deterministic outputs
(e.g., "tool X was invoked", "response contains concept Y", "no error codes
returned"), deterministic mock plugins with known behavior, timeout/retry logic for
flaky tests, structured test result collection and reporting, cost tracking per test.

**E2E test scenarios (minimum 10):**

1. Happy path tool invocation — agent calls tool, gets result
2. Multi-tool session — agent chains multiple tool calls
3. Error handling — agent receives VALIDATION_FAILED, responds appropriately
4. Rate limiting — agent hits limit, receives RATE_LIMITED with retry_after
5. Cross-group rejection — wrong group → UNAUTHORIZED
6. Malformed arguments — bad args → VALIDATION_FAILED → agent self-corrects
7. Session lifecycle — full spawn → communicate → graceful shutdown → cleanup
8. Memory brief injection — session starts with memory context, agent uses it
9. Plugin failure degradation — plugin fails init, agent discovers via get_session_info
10. High-risk tool confirmation — risk_level "high" triggers confirmation flow

**Dependencies**: QA-04, QA-06, DEVOPS-03, ENG-05, ENG-09, ENG-14
**Acceptance criteria**: A simple e2e scenario runs end-to-end. Tests assert on tool
invocations (which tools, what arguments) not exact output. Mock plugins provide
deterministic behavior. Test runner handles timeouts. Results are structured and
CI-reportable. Flaky test tolerance: tests pass 90%+ of runs.
**Complexity**: XL

### ~~QA-11: Build performance benchmark suite~~ DONE

**Status**: Completed (PR #81, merged 2026-02-19)

**Role**: QA
**Description**: Build performance benchmarks for critical paths: ZeroMQ message
throughput (messages/second through full pipeline), SQLite query latency (FTS5 search,
memory brief generation), rate limiter accuracy under concurrent load, container spawn
time, and plugin initialization time. Establish baseline metrics and fail CI if
performance regresses beyond thresholds.
**Dependencies**: QA-04, ENG-01, ENG-02, ENG-03, ENG-08
**Acceptance criteria**: Benchmarks cover: message throughput (>100 msg/s through
pipeline), FTS5 search (<50ms for 1000 entries), container spawn (<10s cold start),
rate limiter accuracy (±5% at boundary). Baselines are recorded. CI detects
regressions.
**Complexity**: L

---

## P2 — Installation Polish & Hardening

These tasks add additional container runtime support, user-facing commands, documentation,
and security hardening that improve the install experience but are not required for a
working installable system.

### ~~DEVOPS-17: Implement Apple Container runtime adapter~~ DONE

**Status**: Completed (PR #83, merged 2026-02-19)

**Role**: DevOps
**Description**: Implement `ContainerRuntime` for Apple Containers (macOS 26+, Apple
Silicon only). Key difference from Docker/Podman: `--publish-socket` for Unix socket
sharing via vsock (bypasses network stack entirely — superior isolation model). Read-only
filesystem is the default behavior. Uses the `container` CLI. Marked **experimental** —
Apple Containers is new and the API surface may evolve with macOS updates.
**Dependencies**: ARCH-04, DEVOPS-12
**Test requirements**: QA-01. Unit tests with mock exec. Integration tests (tagged,
Apple Container-required, macOS 26+ with Apple Silicon only).
**Acceptance criteria**: All `ContainerRuntime` interface methods work with Apple
Containers. vsock socket sharing works for ZeroMQ communication. Read-only root leveraged
(not redundantly re-applied). Adapter is clearly marked experimental. Graceful fallback
with clear message when `container` CLI is absent or macOS version is too old.
**Complexity**: M

### DEVOPS-18: Extend Nix flake outputs for installation

**Role**: DevOps
**Description**: Extend `flake.nix` to include: `packages.${system}.default` (host-side
binary built via `buildNpmPackage` with `pnpmConfigHook`),
`packages.${system}.container-image` (OCI image built via
`dockerTools.buildLayeredImage`), `overlays.default` (for composing into user's nixpkgs).
Handle native ZeroMQ addon compilation within the Nix sandbox. This extends DEVOPS-09
which currently only targets the host binary.
**Dependencies**: DEVOPS-09, DEVOPS-01
**Test requirements**: `nix build` succeeds and produces runnable artifact. `nix build
.#container-image` produces loadable OCI image.
**Acceptance criteria**: `nix build` produces a runnable host artifact with all
dependencies. `nix build .#container-image` produces OCI image loadable by Docker/Podman.
Overlay composes into user nixpkgs without conflicts. Native ZeroMQ addon compiles within
Nix sandbox.
**Complexity**: L

### ~~ENG-22: Implement hello intrinsic tools (first-run experience)~~ DONE

**Status**: Completed (PR #53, merged 2026-02-19)
**Role**: Engineer
**Description**: Add three hello tools extending the core intrinsic tool system (ENG-14):
`hello.greet` (returns a welcome greeting), `hello.echo` (echoes back arguments),
`hello.time` (returns current host time). Registered as intrinsic tools — not a plugin
directory entry. Persist until explicitly disabled via `config.toml`
(`[hello] enabled = false`). `carapace doctor` shows a gentle hint to disable when real
plugins are also loaded. These tools verify the full IPC pipeline works end-to-end during
first run and post-install onboarding (DX-13).
**Dependencies**: ENG-14, ENG-20
**Test requirements**: QA-01. Test: tools invokable through standard pipeline, disable
flag works, tools appear in `list_tools` when enabled and disappear when disabled, pass
full 6-stage validation.
**Acceptance criteria**: Hello tools work through the standard validation pipeline. Config
disable flag works. Tools are useful for verifying end-to-end IPC flow during first run.
Output is welcoming and informative.
**Complexity**: S

### ~~DX-09: Implement `carapace update` command~~ DONE

**Status**: Completed (PR #92, merged 2026-02-19)
**Role**: DX Advocate
**Description**: Add `carapace update` subcommand to the CLI (extends DX-02). Checks
GitHub Releases API for newer version. Downloads new host artifacts to a staging directory
and verifies using SEC-16 verification library (SHA-256 checksums). Pulls matching
container image to prevent host/container version skew. Atomically updates pinned image
digest in config (SEC-17). Only replaces the current install after ALL verifications pass
— failed update leaves current install completely intact. Updates the `version` file.
Runs `carapace doctor` post-update to verify. No phone-home on startup — update check is
explicit only, triggered by user.
**Dependencies**: DX-02, ENG-20, DEVOPS-15, SEC-16, SEC-17
**Test requirements**: QA-01. Test: version comparison logic, download flow (mock HTTP),
checksum verification via SEC-16, failed verification preserves current install, digest
update atomicity, post-update doctor.
**Acceptance criteria**: `carapace update` checks for and installs new versions. Downloads
to staging area — current install untouched until all verifications pass. Checksum
verification works via SEC-16 library. Container image pulled to match host version.
Image digest atomically updated in config. Version file updated. Doctor runs
automatically post-update. Failed update leaves current install intact with clear error.
No automatic update checks on startup.
**Complexity**: M

### ~~DX-10: Implement `carapace uninstall` command~~ DONE

**Status**: Completed (PR #82, merged 2026-02-19)
**Role**: DX Advocate
**Description**: Add `carapace uninstall` subcommand to the CLI. Removes
`$CARAPACE_HOME` directory after confirmation prompt showing exactly what will be deleted
(with sizes). Optionally removes PATH modifications from shell config files
(bash/zsh/fish). `--yes` flag skips confirmation for scripted uninstall. Checks for
running sessions and warns before proceeding.
**Dependencies**: DX-02, ENG-20
**Test requirements**: QA-01. Test: confirmation flow, --yes flag, PATH cleanup
detection, running session warning, dry-run shows deletions without acting.
**Acceptance criteria**: `carapace uninstall` cleanly removes installation. User sees
exactly what will be deleted before proceeding. PATH modifications identified and
optionally removed. `--yes` works for scripted uninstall. Running sessions detected and
warned about.
**Complexity**: S

### ~~DX-12: Implement `carapace config` subcommand~~ DONE

**Status**: Completed (PR #78, merged 2026-02-19)

**Role**: DX Advocate
**Description**: Add `carapace config` subcommand with operations: `get <key>` (read a
config value), `set <key> <value>` (write a config value), `list` (show all config with
source annotations — default vs user-set), `path` (print config file path). This is the
user-facing layer on top of ENG-20's TOML parser. Without this, users must hand-edit TOML
to change runtime, disable hello tools, set plugin directories, etc.
**Dependencies**: DX-02, ENG-20
**Test requirements**: QA-01. Test: get/set/list/path operations, type validation on set,
config file created if missing, invalid key rejected.
**Acceptance criteria**: All four operations work. `set` validates value types. `list`
shows which values are defaults vs user-configured. Config file is created on first `set`
if it doesn't exist. Invalid keys produce helpful error with list of valid keys.
**Complexity**: S

### ~~SEC-19: Implement install-time security smoke tests~~ DONE

**Status**: Completed (PR #93, merged 2026-02-19)
**Role**: Security / QA
**Description**: Build automated security smoke tests that run post-install (invoked by
install script and `carapace doctor`): (1) container cannot reach the network (attempt
DNS + HTTP), (2) container filesystem is read-only (attempt write outside writable
mounts), (3) only `ipc` binary is executable, (4) credential directory has correct
permissions (0700), (5) container image digest matches pinned config value. Tests produce
structured pass/fail results with clear remediation for failures.
**Dependencies**: DEVOPS-16, SEC-17, SEC-18, DEVOPS-05
**Test requirements**: QA-01. Test each smoke test with passing and failing conditions.
**Acceptance criteria**: All 5 smoke tests run and report pass/fail. Install script runs
smoke tests after installation. `carapace doctor` includes smoke test results. Failures
produce specific remediation steps.
**Complexity**: M

### ~~SEC-20: Implement GPG-signed releases~~ DONE

**Status**: Completed (PR #97, merged 2026-02-19)
**Role**: Security / DevOps
**Description**: Add GPG signing to the release pipeline (extends DEVOPS-15). Sign
release tarballs with a project GPG key. Publish the public key in the repository and
on a keyserver. Update install script to optionally verify GPG signatures when `gpg` is
available (non-blocking — cosign is the primary verification method).
**Dependencies**: DEVOPS-15, SEC-15
**Test requirements**: Signature verifiable with published public key. Install script
GPG check works when gpg is present, gracefully skips when absent.
**Acceptance criteria**: Release tarballs are GPG-signed. Public key is published.
Install script verifies GPG when available (falls back to SHA-256 when gpg absent).
Verification instructions documented.
**Complexity**: S

### ~~SEC-21: Document install-path threat model~~ DONE

**Status**: Completed (PR #95, merged 2026-02-19)
**Role**: Security
**Description**: Write a threat model document for the install path covering: (1) attack
surface analysis for both install paths (Nix and script), (2) supply chain trust
assumptions (npm registry, GitHub Releases, GHCR, Sigstore), (3) MITM scenarios and
mitigations, (4) credential storage threat model, (5) container runtime security
comparison matrix (Docker/Podman/Apple Containers × macOS/Linux). Include residual risks
and accepted trade-offs. Published at `docs/INSTALL_SECURITY.md`.
**Dependencies**: SEC-15, SEC-16, SEC-17, SEC-18
**Test requirements**: Review by security team.
**Acceptance criteria**: Threat model covers both install paths. All trust assumptions
documented. Residual risks acknowledged. Security comparison matrix for container runtimes
is accurate. Document is actionable for security auditors.
**Complexity**: M

---

## Existing Task Modifications (Install Strategy)

These existing tasks have updated dependencies or descriptions to integrate with the
install strategy:

### DEVOPS-03: Implement container lifecycle manager

**Modification**: Add dependency on **ARCH-04**. Update description: "Uses
`ContainerRuntime` interface with Docker adapter (DEVOPS-12) as initial implementation"
(replaces "Initially Docker-based"). Runtime adapter injected via DEVOPS-14 auto-detection
or user config.

### DEVOPS-05: Implement health check system (`carapace doctor`)

**Modification**: Add checks for: container runtime detection and isolation level display
(DEVOPS-14), config file validity (ENG-20), credential directory permissions (SEC-18),
version file presence (ENG-20), container image signature and digest status (SEC-16,
SEC-17), security posture summary — green/yellow/red based on isolation level, image
verification, and credential permissions. Add dependencies: ENG-20, SEC-16, SEC-17,
SEC-18, DEVOPS-14.

### DEVOPS-09: Add Nix build output for host binary

**Modification**: Note that **DEVOPS-18** extends this task to include container image
output and overlay. DEVOPS-09 covers the host binary only; DEVOPS-18 adds container
image via `dockerTools.buildLayeredImage`.

### DX-02: Build CLI entry point

**Modification**: Add subcommands: `update` (DX-09), `uninstall` (DX-10), `config`
(DX-12), `setup` (DX-13 re-run trigger). Add dependency on **ENG-20** for config
resolution.

---

## Install Path Dependency Graph

```
ARCH-04 (ContainerRuntime interface)
├── DEVOPS-12 (Docker adapter) ──────┐
├── DEVOPS-13 (Podman adapter)       ├── DEVOPS-14 (auto-detection + isolation level)
└── DEVOPS-17 (Apple adapter, P2)    │
                                     │
ARCH-05 (config schema)              │
└── ENG-20 (TOML parser) ───────────┤
    ├── ENG-21 (dual-dir plugins)    │
    ├── SEC-17 (digest pinning)      │
    └── SEC-18 (credential dir)      │
                                     │
DEVOPS-01 + DEVOPS-02 + DEVOPS-09   │
└── DEVOPS-15 (release pipeline     │
    + cosign + SBOM) ───────────────┤
    └── SEC-16 (verification lib)    │
                                     │
DEVOPS-14 (detection) ──────────────┘
                                     │
DEVOPS-15 (pipeline) ───── DEVOPS-16 (install script)
                           ├── SEC-15 (script hardening)
                           └── SEC-19 (smoke tests, P2)

Auth credential path:
DEVOPS-10 (lockdown) ← ENG-23 (entrypoint wrapper) ← DEVOPS-19 (Dockerfile auth)
                                                      └── DEVOPS-20 (network allowlist)
SEC-18 (credential dir) ← DX-14 (carapace auth CLI)

Post-install:
DX-13 (onboarding) ← ENG-22 (hello tools, P2) + DEVOPS-14
DX-11 (README) ← DEVOPS-16 + DEVOPS-18
DEVOPS-05 (doctor) ← SEC-16 + SEC-17 + SEC-18 + DEVOPS-14
DX-02 (CLI) ← DX-14 (auth) + DX-09 (update, P2) + DX-10 (uninstall, P2) +
              DX-12 (config, P2)
```

### Shortest Path to Working Install

1. **ARCH-04** + **ARCH-05** (parallel — interface + config schema)
2. **ENG-20** + **DEVOPS-12** + **DEVOPS-13** (parallel — config impl + Docker + Podman)
3. **ENG-21** + **DEVOPS-14** + **SEC-17** + **SEC-18** (parallel — plugins + detection +
   security)
4. **DEVOPS-15** (release pipeline — needs existing CI + Nix build)
5. **SEC-16** (verification library — needs pipeline artifacts to verify against)
6. **DEVOPS-16** (install script — needs pipeline + verification)
7. **SEC-15** + **DX-11** + **DX-13** (parallel — script review + README + onboarding)

---

## CI Pipeline Design

### Stage Architecture

```
┌─────────────────────────────────────────────────────────┐
│  STAGE 1: FAST CHECKS  (parallel, < 30s)                │
│  ├── oxlint (lint)                                      │
│  ├── prettier --check (format)                          │
│  ├── tsc --noEmit (type check)                          │
│  └── pnpm audit --audit-level=high (baseline deps)      │
│  Gate: All must pass.                                   │
├─────────────────────────────────────────────────────────┤
│  STAGE 2: UNIT TESTS + COVERAGE  (< 3 min)             │
│  ├── vitest run (all unit tests)                        │
│  ├── Coverage collection (v8 provider)                  │
│  └── Coverage gates:                                    │
│      Global: 80% line, 70% branch                       │
│      Security modules: 90% line, 80% branch             │
│  Gate: 100% tests pass + coverage thresholds met.       │
├─────────────────────────────────────────────────────────┤
│  STAGE 3: SECURITY SCANNING  (parallel, < 5 min)       │
│  ├── Semgrep (custom Carapace SAST rules)               │
│  ├── CodeQL (GitHub-native deep analysis)               │
│  └── Socket.dev (supply chain risk)                     │
│  Gate: Zero high/critical Semgrep + CodeQL findings.    │
│  Socket.dev is advisory (non-blocking).                 │
├─────────────────────────────────────────────────────────┤
│  STAGE 4: INTEGRATION + SECURITY TESTS  (< 5 min)      │
│  ├── ZeroMQ integration tests (QA-04)                   │
│  ├── Plugin conformance tests (QA-05)                   │
│  └── Security boundary tests (SEC-05)                   │
│  Gate: 100% pass.                                       │
├─────────────────────────────────────────────────────────┤
│  STAGE 5: CONTAINER TESTS  (on merge to main, < 15 min) │
│  ├── Container build + Trivy scan (DEVOPS-08)           │
│  ├── Container lifecycle tests (QA-06)                  │
│  └── Container security verification (SEC-07)           │
│  Gate: All pass. Trivy high/critical block.             │
├─────────────────────────────────────────────────────────┤
│  STAGE 6: E2E TESTS  (on merge to main, < 15 min)      │
│  └── Claude Code e2e scenarios (QA-08)                  │
│  Gate: 90% pass rate (non-deterministic tolerance).     │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│  SCHEDULED (not per-PR):                                │
│  ├── Nightly: Full Claude Code e2e suite + adversarial  │
│  │           security tests (SEC-12) with budget caps   │
│  ├── Weekly: OpenSSF Scorecard                          │
│  └── Weekly: Performance benchmark regression check     │
└─────────────────────────────────────────────────────────┘
```

### Quality Gates Summary

| Gate                | Tool          | Threshold            | Blocks Merge  |
| ------------------- | ------------- | -------------------- | :-----------: |
| Lint                | oxlint        | Zero errors          |      Yes      |
| Format              | prettier      | All files pass       |      Yes      |
| Types               | tsc --noEmit  | Zero errors          |      Yes      |
| Deps                | pnpm audit    | Zero high/critical   |      Yes      |
| Unit tests          | vitest        | 100% pass            |      Yes      |
| Coverage (global)   | v8            | 80% line, 70% branch |      Yes      |
| Coverage (security) | v8            | 90% line, 80% branch |      Yes      |
| Semgrep             | custom rules  | Zero high/critical   |      Yes      |
| CodeQL              | github-native | Zero high/critical   |      Yes      |
| Integration tests   | vitest        | 100% pass            |      Yes      |
| Security tests      | vitest        | 100% pass            |      Yes      |
| Container scan      | Trivy         | Zero high/critical   | Yes (on main) |
| Container tests     | vitest        | 100% pass            | Yes (on main) |
| E2E tests           | Claude Code   | 90% pass rate        | Yes (on main) |
| Supply chain        | Socket.dev    | Advisory             |      No       |
| OpenSSF             | Scorecard     | Score > 7            |      No       |

---

## Testing Pyramid

```
          /\
         /  \     E2E via Claude Code (QA-08)
        / 10 \    Non-deterministic, validates full system
       /------\
      /        \   Adversarial Security E2E (SEC-12)
     /  7 tests \  Prompt injection, memory poisoning, escape attempts
    /------------\
   /              \  Integration (QA-04, QA-05, QA-06, SEC-05, SEC-07)
  / ~50-100 tests  \ Real ZeroMQ, real containers, real validation pipeline
 /------------------\
/                    \  Unit Tests (TDD on every module)
/ Hundreds of tests    \ Every ENG/SEC/DX task has unit tests via strict TDD
/________________________\
```

### Plugin Author Testing Layers

1. **Unit tests** (Vitest + Plugin Test SDK DX-06): Test handler logic in isolation.
   `pnpm test -- plugins/my-plugin/`. Subsecond feedback.
2. **Conformance tests** (QA-05): Validate manifest contract.
   `pnpm test:conformance -- plugins/my-plugin/`
3. **Integration tests** (QA-04): Test through real ZeroMQ messaging pipeline.
   `pnpm test:integration -- plugins/my-plugin/`
4. **E2E tests** (QA-08): Full Claude Code session with plugin. Non-deterministic.
   `pnpm test:e2e -- plugins/my-plugin/`

---

## Dependency Graph (Critical Path)

```
ARCH-01 (bootstrap)
├── ARCH-02 (message types) ──┐
├── ARCH-03 (manifest schema) │
├── QA-01 (test framework)    │
├── DEVOPS-01 (Dockerfile)    │
├── DEVOPS-02 (CI pipeline)   │
└── ENG-08 (SQLite layer)     │  ← can start immediately
                               │
ENG-01 (PUB/SUB) ─────────────┤
ENG-02 (ROUTER/DEALER) ───────┤──── ENG-05 (IPC binary)
                               │     ↑ parallel with ENG-03!
                               ▼
                    ENG-03 (core router)
                         │
          ┌──────────────┼──────────────────────┐
          ▼              ▼                      ▼
    ENG-04           ENG-06                  SEC-02
  (plugin loader)  (session mgr)         (response sanitize)
      │                │                      │
      │           ┌────┴────┐                 │
      │           ▼         ▼                 ▼
      │      ENG-17     SEC-03          ENG-18
      │    (audit log) (rate limiter) (ToolError)
      │         │           │
      │         ▼           ▼
      │     ENG-14      SEC-01 (host-side validation)
      │   (intrinsic       │
      │    tools)     ┌────┼────────┐
      │               ▼    ▼        ▼
      │          SEC-04  ENG-15   SEC-08
      │        (group   (confirm  (DoS
      │         auth)    gate)   prevention)
      │
      ├── SEC-10 (manifest security)
      ├── ENG-09 (skill loader)
      │
      ▼
DEVOPS-03 (container lifecycle)
      │
      ├── DEVOPS-10 (permission lockdown)
      ├── ENG-19 (event-to-agent logic)
      │
      ▼
Full end-to-end session
      │
 ┌────┼────────┬─────────┐
 ▼    ▼        ▼         ▼
ENG-10 DX-03  QA-06    SEC-07
(memory (scaffold)(lifecycle (container
 data)  CLI)    tests)  security)
 │
 ▼
ENG-11 (memory tools) ──→ QA-08 (Claude Code e2e)
 │                              │
 ├── ENG-12 (skill file)        ▼
 └── ENG-13 (brief hook)   SEC-12 (adversarial e2e)
```

### Auth Credential Path

```
DEVOPS-01 (Dockerfile)
├── DEVOPS-10 (permission lockdown)
│   └── ENG-23 (entrypoint wrapper) ─── reads stdin, exports env, exec claude
│       └── DEVOPS-19 (Dockerfile auth update) ─── adds Claude CLI + entrypoint
│           └── DEVOPS-20 (network allowlist) ─── restricts to api.anthropic.com
│
ARCH-05 (config schema)
└── ENG-20 (TOML parser)
    └── SEC-18 (credential dir security)
        └── DX-14 (carapace auth CLI) ─── api-key, login, status commands
```

### Shortest Path to Working System

1. ARCH-01 → ARCH-02 → ENG-01 + ENG-02 → ENG-03 + ENG-05 (parallel) → ENG-04 +
   ENG-06 → DEVOPS-03
2. This gets you: project structure → message types → both ZeroMQ channels → router +
   IPC binary (parallel) → plugin loader + sessions → container lifecycle = **a running
   agent that can invoke tools**

### Shortest Path to Demo (with Auth)

1. ENG-05 (IPC binary) + ARCH-04 + ARCH-05 + ENG-18 (parallel — all dependencies met)
2. ENG-09 + ENG-14 + ENG-20 + DEVOPS-12 (parallel — skill loader, intrinsics, config,
   Docker adapter)
3. DEVOPS-03 + DEVOPS-04 + DEVOPS-10 + SEC-18 (parallel — container lifecycle, sockets,
   permission lockdown, credential dir)
4. ENG-23 + DX-14 + DX-02 (parallel — entrypoint wrapper, auth CLI, main CLI)
5. DEVOPS-19 (Dockerfile update with Claude CLI + entrypoint)
6. Smoke test: `carapace auth api-key` → `carapace start` → agent invokes echo plugin
   via IPC → response returned

### Parallel Work Streams from ARCH-01

These can all start immediately after ARCH-01:

- ARCH-02 + ARCH-03 (types and schemas)
- QA-01 + QA-03 + QA-09 + QA-10 (test infrastructure)
- DEVOPS-01 + DEVOPS-02 (container + CI)
- ENG-08 (SQLite layer — no messaging dependency)

---

## Phase E2E — End-to-End Plumbing

> Goal: complete round-trip — `carapace start` → container with Claude Code →
> echo plugin invocation via IPC → response returned. All tasks completed
> 2026-02-19 (PRs #103-108), each code reviewed before merge.

### ~~ENG-24: Implement ZmqSocketFactory (production SocketFactory)~~ DONE

**Status**: Completed (PR #103, merged 2026-02-19)
**Role**: Engineer
**Priority**: P1
**Description**: Real `SocketFactory` implementation using the `zeromq` npm
package. Creates Router, Dealer, Publisher, and Subscriber sockets bound to
Unix socket paths.
**Dependencies**: None
**Complexity**: M

### ~~ENG-25: Implement server orchestrator (composition root)~~ DONE

**Status**: Completed (PR #104, merged 2026-02-19)
**Role**: Engineer / Architect
**Priority**: P1
**Description**: `src/server.ts` composition root wiring all subsystems:
ZmqSocketFactory → SocketProvisioner → RequestChannel → EventBus →
PluginLoader → ToolCatalog → SessionManager → MessageRouter. ResponseSanitizer
wired into dispatch path. Blocking server loop with SIGINT/SIGTERM handling.
**Dependencies**: ENG-24
**Complexity**: L

### ~~ENG-26: Wire main() entry point and update CLI start command~~ DONE

**Status**: Completed (PR #105, merged 2026-02-19)
**Role**: Engineer / DX
**Priority**: P1
**Description**: `src/main.ts` with `main()` function wiring real `CliDeps`
to `runCommand()`. Updated `start()` to run the server (blocking) instead of
just writing a PID. Updated `flake.nix` wrapper to `dist/main.js`.
**Dependencies**: ENG-25
**Complexity**: M

### ~~ENG-27: Build Docker container with Claude Code + echo plugin~~ DONE

**Status**: Completed (PR #106, merged 2026-02-19)
**Role**: DevOps / Engineer
**Priority**: P1
**Description**: Added `stdinData` field to `ContainerRunOptions` for
credential injection via stdin pipe (not env vars). Two-step `docker create -i`

- `docker start -ai` flow in DockerRuntime. Echo plugin skill file added.
  **Dependencies**: ENG-26
  **Complexity**: L

### ~~ENG-28: End-to-end echo plugin invocation~~ DONE

**Status**: Completed (PR #107, merged 2026-02-19)
**Role**: Engineer / QA
**Priority**: P1
**Description**: Intrinsic echo tool registered in server.ts during boot
(always available, no filesystem discovery). Full round-trip tested: client
DEALER → RequestChannel → Server.handleRequest → SessionManager →
MessageRouter → echoToolHandler → ResponseSanitizer → response. 8 E2E tests
including credential sanitization verification.
**Dependencies**: ENG-27
**Complexity**: M

### ~~QA-11: E2E smoke test~~ DONE

**Status**: Completed (PR #108, merged 2026-02-19)
**Role**: QA
**Priority**: P1
**Description**: Automated test suite validating the full Phase E2E pipeline.
74 tests across 4 files, runs in ~530ms via `pnpm run test:e2e`. Covers:
full round-trip with cleanup, credential sanitization, multi-container
isolation, validation rejection, unknown tool error, server stop idempotency,
container crash detection, sequential request integrity.
**Dependencies**: ENG-28
**Complexity**: M

### Phase E2E dependency graph

```
ENG-24 (ZmqSocketFactory) ✓
  └── ENG-25 (server orchestrator) ✓
        └── ENG-26 (main() + CLI start) ✓
              └── ENG-27 (Docker container image) ✓
                    └── ENG-28 (echo round-trip) ✓
                          └── QA-11 (E2E smoke test) ✓
```

---

## Phase IMG — Container Image Versioning

Composite image tags, OCI labels, staleness detection, and auto-rebuild.
Prevents host/container version skew during development and upgrades.

### ~~IMG-01: Add build() and inspectLabels() to ContainerRuntime~~ DONE

**Status**: Completed (PR #121, merged 2026-02-19)

- **Priority**: P1 | **Complexity**: M | **Role**: ENG
- Extend ContainerRuntime interface with `build(options)` and
  `inspectLabels(image)`. Implement in Docker, Podman, Apple Containers.
- `ImageBuildOptions` type: contextDir, dockerfile?, tag, buildArgs?, labels?

### ~~IMG-02: Create image-identity module~~ DONE

**Status**: Completed (PR #122, merged 2026-02-19)

- **Priority**: P1 | **Complexity**: S | **Role**: ENG
- `src/core/image-identity.ts` — resolveGitSha, isImageCurrent, compositeTag,
  parseLabels. OCI label key constants.
- **Depends on**: IMG-01

### ~~IMG-03: Create image-builder module~~ DONE

**Status**: Completed (PR #124, merged 2026-02-19)

- **Priority**: P1 | **Complexity**: M | **Role**: ENG
- `src/core/image-builder.ts` — buildImage() orchestrates version resolution,
  build args, OCI labels, post-build label verification.
- **Depends on**: IMG-02

### ~~IMG-04: Wire image build into update command~~ DONE

**Status**: Completed (PR #127, merged 2026-02-19)

- **Priority**: P1 | **Complexity**: S | **Role**: ENG
- Add optional `buildImage` and `projectRoot` to UpdateCommandDeps.
  Call buildImage after image digest pinning in update flow.
- **Depends on**: IMG-03

### ~~IMG-05: Wire staleness check into start + SKIP_IMAGE_BUILD~~ DONE

**Status**: Completed (PR #126, merged 2026-02-19)

- **Priority**: P1 | **Complexity**: M | **Role**: ENG
- Add optional image deps to CliDeps. Check staleness before container spawn.
  `SKIP_IMAGE_BUILD=1` bypasses check during development.
- **Depends on**: IMG-03

### ~~IMG-06: Add OCI label ARGs to Dockerfile~~ DONE

**Status**: Completed (PR #120, merged 2026-02-19)

- **Priority**: P1 | **Complexity**: S | **Role**: DEVOPS
- Add CARAPACE_VERSION, GIT_SHA, BUILD_DATE build ARGs and 4 OCI LABELs to
  Dockerfile runtime stage.

### ~~IMG-07: Add image version reporting to carapace doctor~~ DONE

**Status**: Completed (PR #125, merged 2026-02-19)

- **Priority**: P2 | **Complexity**: S | **Role**: DX
- Add checkImageVersion health check. Reports pass (current), warn (stale),
  fail (missing), or pass (not configured).
- **Depends on**: IMG-02

### ~~IMG-08: Image versioning test coverage~~ DONE

**Status**: Completed (PR #128, merged 2026-02-19)

- **Priority**: P2 | **Complexity**: M | **Role**: QA
- 18 new tests across cli.test.ts, image-identity.test.ts,
  image-builder.test.ts, health-checks.test.ts. Covers state machine,
  failure modes, edge cases, and integration flows.
- **Depends on**: IMG-05, IMG-07

---

## Task Summary

| Category  |   Count |     P0 |     P1 |     P2 |
| --------- | ------: | -----: | -----: | -----: |
| ARCH      |       5 |      3 |      2 |      0 |
| ENG       |      28 |      4 |     17 |      7 |
| SEC       |      21 |      0 |      9 |     12 |
| DEVOPS    |      20 |      2 |     12 |      6 |
| DX        |      14 |      0 |      6 |      8 |
| QA        |      12 |      5 |      3 |      4 |
| IMG       |       8 |      0 |      6 |      2 |
| **Total** | **108** | **14** | **55** | **39** |
