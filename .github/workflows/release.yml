# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write
  id-token: write

env:
  IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/carapace-agent

jobs:
  # ---------------------------------------------------------------------------
  # Stage 1: Build platform-specific tarballs
  # ---------------------------------------------------------------------------
  build:
    name: Build (${{ matrix.target }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: linux-x86_64
            runner: ubuntu-latest
            platform: linux
            arch: amd64
          - target: linux-arm64
            runner: ubuntu-latest
            platform: linux
            arch: arm64
          - target: macos-arm64
            runner: macos-14
            platform: darwin
            arch: arm64
          - target: macos-x86_64
            runner: macos-13
            platform: darwin
            arch: amd64
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: Install pnpm
        run: corepack enable && corepack prepare pnpm@10.28.0 --activate

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm run build

      - name: Create tarball
        run: |
          tar czf carapace-${{ matrix.target }}.tar.gz \
            dist/ \
            package.json \
            node_modules/

      - name: Generate SHA-256 checksum
        run: shasum -a 256 carapace-${{ matrix.target }}.tar.gz > carapace-${{ matrix.target }}.tar.gz.sha256

      - uses: actions/upload-artifact@5d5d22a31266ced268874388b861e4b58bb5c2f3 # v4.3.1
        with:
          name: carapace-${{ matrix.target }}
          path: |
            carapace-${{ matrix.target }}.tar.gz
            carapace-${{ matrix.target }}.tar.gz.sha256

  # ---------------------------------------------------------------------------
  # Stage 2: Multi-arch container image â†’ GHCR
  # ---------------------------------------------------------------------------
  container:
    name: Container Image
    runs-on: ubuntu-latest
    needs: [build]
    outputs:
      digest: ${{ steps.push.outputs.digest }}
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - uses: docker/setup-qemu-action@68827325e0b33c7199eb31dd4e31fbe9023e06e3 # v3.0.0

      - uses: docker/setup-buildx-action@f95db51fddba0c2d1ec667646a06c2ce06100226 # v3.0.0

      - uses: docker/login-action@343f7c4344506bcbf9b4de18042ae17996df046d # v3.0.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - uses: docker/metadata-action@8e5442c4ef9f78752691e2d8f8d19755c6f78e81 # v5.5.1
        id: meta
        with:
          images: ${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha

      - uses: docker/build-push-action@2cdde995de11925a030ce8070c3d77a52ffcf1c0 # v5.3.0
        id: push
        with:
          context: .
          push: true
          platforms: linux/amd64,linux/arm64
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  # ---------------------------------------------------------------------------
  # Stage 3: Cosign signing + SBOM
  # ---------------------------------------------------------------------------
  sign:
    name: Sign & SBOM
    runs-on: ubuntu-latest
    needs: [container]
    steps:
      - uses: sigstore/cosign-installer@59acb6260d9c0ba8f4a2f9d9b48431a222b68e20 # v3.5.0

      - name: Sign container image (keyless)
        run: cosign sign --yes "${{ env.IMAGE_NAME }}@${{ needs.container.outputs.digest }}"

      - uses: anchore/sbom-action@78fc58e266e87a38d4194b2137a3d4e9bcaf7ca1 # v0.17.0
        with:
          image: ${{ env.IMAGE_NAME }}@${{ needs.container.outputs.digest }}
          output-file: sbom.spdx.json

      - uses: actions/upload-artifact@5d5d22a31266ced268874388b861e4b58bb5c2f3 # v4.3.1
        with:
          name: sbom
          path: sbom.spdx.json

  # ---------------------------------------------------------------------------
  # Stage 3b: GPG-sign release tarballs
  # ---------------------------------------------------------------------------
  gpg-sign:
    name: GPG Sign Tarballs
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - uses: actions/download-artifact@c850b930e6ba138125429b7e5c93fc707a7f8427 # v4.1.4
        with:
          path: artifacts/

      - name: Import GPG signing key
        run: echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}

      - name: GPG sign each tarball
        run: |
          for tarball in artifacts/**/*.tar.gz; do
            gpg --batch --detach-sign --armor \
              --local-user "${{ vars.GPG_KEY_ID }}" \
              "$tarball"
          done

      - uses: actions/upload-artifact@5d5d22a31266ced268874388b861e4b58bb5c2f3 # v4.3.1
        with:
          name: gpg-signatures
          path: artifacts/**/*.asc

  # ---------------------------------------------------------------------------
  # Stage 4: GitHub Release with all artifacts
  # ---------------------------------------------------------------------------
  release:
    name: GitHub Release
    runs-on: ubuntu-latest
    needs: [build, container, sign, gpg-sign]
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - uses: actions/download-artifact@c850b930e6ba138125429b7e5c93fc707a7f8427 # v4.1.4
        with:
          path: artifacts/

      - name: Collect release files
        run: |
          mkdir -p release-files
          find artifacts/ -type f \( -name '*.tar.gz' -o -name '*.sha256' -o -name '*.json' -o -name '*.asc' \) \
            -exec cp {} release-files/ \;

      - name: Generate combined SHA256SUMS
        working-directory: release-files
        run: |
          sha256sum *.tar.gz > SHA256SUMS

      - uses: softprops/action-gh-release@de2c0eb89ae2a093876385947365aca7b0e5f844 # v2.0.4
        with:
          files: release-files/*
          generate_release_notes: true
          body: |
            ## Container Image

            ```
            ${{ env.IMAGE_NAME }}@${{ needs.container.outputs.digest }}
            ```

            **Image digest**: `${{ needs.container.outputs.digest }}`

            Pull with:
            ```bash
            docker pull ${{ env.IMAGE_NAME }}@${{ needs.container.outputs.digest }}
            ```

            ## Verification

            **GPG signature**: Each tarball has a detached `.asc` signature.
            ```bash
            # Import the project public key
            curl -sSL https://raw.githubusercontent.com/fred-drake/carapace/master/keys/release-key.asc | gpg --import
            # Verify a tarball
            gpg --verify carapace-linux-x86_64.tar.gz.asc carapace-linux-x86_64.tar.gz
            ```

            **SHA-256 checksums**: See `SHA256SUMS` file.
            ```bash
            sha256sum -c SHA256SUMS
            ```
